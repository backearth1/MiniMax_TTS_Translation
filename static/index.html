<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniMax TTSÈÖçÈü≥ÁøªËØëÂ∑•ÂÖ∑</title>
    <link rel="icon" type="image/png" href="/static/mm_logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="/static/css/project-manager.css" rel="stylesheet">
    <link href="/static/css/progress-tracker.css" rel="stylesheet">
    <link href="/static/css/inline-editor.css" rel="stylesheet">
    <link href="/static/css/main-theme.css" rel="stylesheet">
</head>
<body>
    <!-- ÂØºËà™Ê†è -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 text-dark d-flex align-items-center">
                <img src="/static/mm_logo.png" alt="MiniMax" style="height: 32px; width: auto; margin-right: 8px;">MiniMax TTSÈÖçÈü≥ÁøªËØëÂ∑•ÂÖ∑
            </span>
        </div>
    </nav>

    <div class="container-fluid p-4">
        <!-- Êñ∞Â∏ÉÂ±ÄÔºöÂ∑¶‰æßSRTÂ§ÑÁêÜÔºåÂè≥‰æßÂèÇÊï∞ÈÖçÁΩÆÂíåÊéßÂà∂Âå∫ -->
        <div class="row g-4">
            <!-- Â∑¶‰æßÔºöSRTÂ§ÑÁêÜÂå∫Âüü -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-gear-wide-connected me-2"></i>SRTÂ§ÑÁêÜ</h5>
                    </div>
                    <div class="card-body">
                        <!-- ‰∏âÁªÑÊåâÈíÆÂ∏ÉÂ±Ä -->
                        <div class="row g-3 mb-4">
                            <!-- Á¨¨‰∏ÄÁªÑÔºöSRT‰∏ä‰º†‰∏ãËΩΩ -->
                            <div class="col-md-4">
                                <h6 class="text-muted mb-2"><i class="bi bi-file-earmark-text me-1"></i>SRTÊñá‰ª∂</h6>
                                <div class="d-grid gap-2">
                                    <input type="file" id="quickSrtUpload" accept=".srt" style="display: none;">
                                    <button class="btn btn-primary btn-sm" onclick="document.getElementById('quickSrtUpload').click()">
                                        <i class="bi bi-upload me-1"></i>‰∏ä‰º†SRT
                                    </button>
                                    <button class="btn btn-warning btn-sm" id="exportSrtBtn" onclick="exportSrtFile()" style="display: none;">
                                        <i class="bi bi-download me-1"></i>ÂØºÂá∫SRT
                                    </button>
                                </div>
                            </div>

                            <!-- Á¨¨‰∫åÁªÑÔºöÈ°πÁõÆÁÆ°ÁêÜ -->
                            <div class="col-md-4">
                                <h6 class="text-muted mb-2"><i class="bi bi-folder2-open me-1"></i>È°πÁõÆÁÆ°ÁêÜ</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-info btn-sm" onclick="toggleProjectManager()" id="projectManagerToggle">
                                        <i class="bi bi-collection me-1"></i>ÊàëÁöÑÈ°πÁõÆ
                                        <span class="badge bg-light text-dark ms-1" id="projectCountBadge">0/5</span>
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="refreshProjectList()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Âà∑Êñ∞È°πÁõÆ
                                    </button>
                                </div>
                            </div>

                            <!-- Á¨¨‰∏âÁªÑÔºöÊâπÈáè‰øÆÊîπËØ¥ËØù‰∫∫ -->
                            <div class="col-md-4">
                                <h6 class="text-muted mb-2"><i class="bi bi-people me-1"></i>ÊâπÈáèÊìç‰Ωú</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="toggleBatchSpeakerPanel()" id="batchSpeakerToggle">
                                        <i class="bi bi-people-fill me-1"></i>ÊâπÈáèÊîπËØ¥ËØù‰∫∫
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" onclick="selectAllSegments()" id="selectAllBtn">
                                        <i class="bi bi-check-all me-1"></i>ÂÖ®ÈÄâÊÆµËêΩ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- È°πÁõÆÁÆ°ÁêÜÈù¢Êùø - ÁªÑ‰ª∂Âåñ -->
                        <div id="projectPanelSection"></div>

                        <!-- ÊâπÈáèÊìç‰ΩúÈù¢Êùø - ÁªÑ‰ª∂Âåñ -->
                        <div id="batchPanelSection"></div>

                        <!-- ÁøªËØëÂäüËÉΩÂå∫Âüü -->
                        <div class="d-flex gap-2 justify-content-center mb-3" id="translationSection" style="display: none;">
                        </div>

                        <!-- Â≠óÂπïÊÆµËêΩÂàóË°® -->
                        <div class="subtitle-editor" id="subtitleEditor" style="min-height: 200px;">
                            <div class="text-center py-5" style="color: var(--pink-400);">
                                <i class="bi bi-hourglass-split fs-1"></i>
                                <p class="mt-2">Ê≠£Âú®Âä†ËΩΩÁ§∫‰æãÂ≠óÂπïÊñá‰ª∂...</p>
                            </div>
                        </div>

                        <!-- ÂàÜÈ°µÊéßÂà∂ -->
                        <div class="d-flex justify-content-between align-items-center mt-3" id="paginationControls" style="display: none;">
                            <button class="btn btn-sm btn-outline-primary" id="prevPage" disabled>
                                <i class="bi bi-chevron-left"></i> ‰∏ä‰∏ÄÈ°µ
                            </button>
                            <span id="pageInfo" style="color: var(--pink-600);">Á¨¨ 1 È°µ</span>
                            <button class="btn btn-sm btn-outline-primary" id="nextPage" disabled>
                                ‰∏ã‰∏ÄÈ°µ <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Âè≥‰æßÔºöÂèÇÊï∞ÈÖçÁΩÆÂíåÊéßÂà∂Âå∫ -->
            <div class="col-lg-4">
                <!-- ‰∏äÂçäÈÉ®ÂàÜÔºöÂèÇÊï∞ÈÖçÁΩÆ -->
                <div class="row g-4 mb-5">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-gear-fill me-2"></i>ÈÖçÁΩÆÂèÇÊï∞</h5>
                            </div>
                            <div class="card-body config-section">
                                <form id="configForm">
                                    <!-- APIÈÖçÁΩÆ -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-6">
                                            <label for="groupId" class="form-label">
                                                Group ID
                                                <i class="bi bi-info-circle text-muted" title="Â∞ÜËá™Âä®‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®"></i>
                                            </label>
                                            <input type="text" class="form-control" id="groupId" required style="border-color: #2196f3;" placeholder="ËæìÂÖ•ÊÇ®ÁöÑGroup ID">
                                        </div>
                                        <div class="col-6">
                                            <label for="apiKey" class="form-label">
                                                API Key
                                                <i class="bi bi-info-circle text-muted" title="Â∞ÜËá™Âä®‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®"></i>
                                            </label>
                                            <input type="password" class="form-control" id="apiKey" required style="border-color: #2196f3;" placeholder="ËæìÂÖ•ÊÇ®ÁöÑAPI Key">
                                        </div>
                                    </div>
                                    
                                    
                                    <!-- APIÁ´ØÁÇπÈÄâÊã© -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-12">
                                            <label for="apiEndpoint" class="form-label">
                                                <i class="bi bi-globe"></i> APIÊé•ÂÖ•ÁÇπ
                                            </label>
                                            <select class="form-select" id="apiEndpoint" style="border-color: #2196f3;">
                                                <option value="domestic" selected>üá®üá≥ ÂõΩÂÜÖ (api.minimaxi.com)</option>
                                                <option value="overseas">üåç Êµ∑Â§ñ (api.minimax.io)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- ËØ≠Èü≥ÈÖçÁΩÆ -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-8">
                                            <label for="voiceModel" class="form-label">ËØ≠Èü≥Ê®°Âûã</label>
                                            <input type="text" class="form-control" id="voiceModel" value="speech-02-hd">
                                        </div>
                                        <div class="col-4">
                                            <label for="language" class="form-label">ËØ≠Ë®Ä</label>
                                            <select class="form-select" id="language">
                                                <option value="Chinese">‰∏≠Êñá</option>
                                                <option value="Chinese,Yue">Á≤§ËØ≠</option>
                                                <option value="English">Ëã±ËØ≠</option>
                                                <option value="Arabic">ÈòøÊãâ‰ºØËØ≠</option>
                                                <option value="Russian">‰øÑËØ≠</option>
                                                <option value="Spanish">Ë•øÁè≠ÁâôËØ≠</option>
                                                <option value="French">Ê≥ïËØ≠</option>
                                                <option value="Portuguese">Ëë°ËêÑÁâôËØ≠</option>
                                                <option value="German">Âæ∑ËØ≠</option>
                                                <option value="Turkish">ÂúüËÄ≥ÂÖ∂ËØ≠</option>
                                                <option value="Dutch">Ëç∑ÂÖ∞ËØ≠</option>
                                                <option value="Ukrainian">‰πåÂÖãÂÖ∞ËØ≠</option>
                                                <option value="Vietnamese">Ë∂äÂçóËØ≠</option>
                                                <option value="Indonesian">Âç∞Â∞ºËØ≠</option>
                                                <option value="Japanese">Êó•ËØ≠</option>
                                                <option value="Italian">ÊÑèÂ§ßÂà©ËØ≠</option>
                                                <option value="Korean">Èü©ËØ≠</option>
                                                <option value="Thai">Ê≥∞ËØ≠</option>
                                                <option value="Polish">Ê≥¢ÂÖ∞ËØ≠</option>
                                                <option value="Romanian">ÁΩóÈ©¨Â∞º‰∫öËØ≠</option>
                                                <option value="Greek">Â∏åËÖäËØ≠</option>
                                                <option value="Czech">Êç∑ÂÖãËØ≠</option>
                                                <option value="Finnish">Ëä¨ÂÖ∞ËØ≠</option>
                                                <option value="Hindi">Âç∞Âú∞ËØ≠</option>
                                                <option value="Bulgarian">‰øùÂä†Âà©‰∫öËØ≠</option>
                                                <option value="Danish">‰∏πÈ∫¶ËØ≠</option>
                                                <option value="Hebrew">Â∏å‰ºØÊù•ËØ≠</option>
                                                <option value="Malay">È©¨Êù•ËØ≠</option>
                                                <option value="Persian">Ê≥¢ÊñØËØ≠</option>
                                                <option value="Slovak">ÊñØÊ¥õ‰ºêÂÖãËØ≠</option>
                                                <option value="Swedish">ÁëûÂÖ∏ËØ≠</option>
                                                <option value="Croatian">ÂÖãÁΩóÂú∞‰∫öËØ≠</option>
                                                <option value="Filipino">Ëè≤ÂæãÂÆæËØ≠</option>
                                                <option value="Hungarian">ÂåàÁâôÂà©ËØ≠</option>
                                                <option value="Norwegian">Êå™Â®ÅËØ≠</option>
                                                <option value="Slovenian">ÊñØÊ¥õÊñáÂ∞º‰∫öËØ≠</option>
                                                <option value="Catalan">Âä†Ê≥∞ÁΩóÂ∞º‰∫öËØ≠</option>
                                                <option value="Nynorsk">Êñ∞Êå™Â®ÅËØ≠</option>
                                                <option value="Tamil">Ê≥∞Á±≥Â∞îËØ≠</option>
                                                <option value="Afrikaans">ÂçóÈùûËç∑ÂÖ∞ËØ≠</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- ËßíËâ≤ËØ≠Èü≥ÈÖçÁΩÆ -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-6">
                                            <label for="speaker00Voice" class="form-label">SPEAKER_00 ËØ≠Èü≥</label>
                                            <input type="text" class="form-control" id="speaker00Voice" value="ai_her_04">
                                        </div>
                                        <div class="col-6">
                                            <label for="speaker01Voice" class="form-label">SPEAKER_01 ËØ≠Èü≥</label>
                                            <input type="text" class="form-control" id="speaker01Voice" value="wumei_yujie">
                                        </div>
                                    </div>
                                    <div class="row g-3 mb-3">
                                        <div class="col-6">
                                            <label for="speaker02Voice" class="form-label">SPEAKER_02 ËØ≠Èü≥</label>
                                            <input type="text" class="form-control" id="speaker02Voice" value="uk_oldwoman4">
                                        </div>
                                        <div class="col-6">
                                            <label for="speaker03Voice" class="form-label">SPEAKER_03 ËØ≠Èü≥</label>
                                            <input type="text" class="form-control" id="speaker03Voice" value="female-chengshu">
                                        </div>
                                    </div>
                                    <div class="row g-3 mb-3">
                                        <div class="col-6">
                                            <label for="speaker04Voice" class="form-label">SPEAKER_04 ËØ≠Èü≥</label>
                                            <input type="text" class="form-control" id="speaker04Voice" value="Serene_Elder">
                                        </div>
                                        <div class="col-6">
                                            <label for="speaker05Voice" class="form-label">SPEAKER_05 ËØ≠Èü≥</label>
                                            <input type="text" class="form-control" id="speaker05Voice" value="Serene_Elder">
                                        </div>
                                    </div>
                                    
                                    <!-- Ëá™ÂÆö‰πâËßíËâ≤Âå∫Âüü -->
                                    <div id="customSpeakersContainer"></div>
                                    
                                    <!-- Â¢ûÂä†ËßíËâ≤ÊåâÈíÆ -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-12">
                                            <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="showAddSpeakerModal()">
                                                <i class="bi bi-person-plus me-1"></i>Â¢ûÂä†Ëá™ÂÆö‰πâËßíËâ≤
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ•ÔºåÁî®‰∫éÂÖºÂÆπÁé∞ÊúâÁîüÊàêÈÄªËæë -->
                                    <input type="file" id="subtitleFile" accept=".srt,.txt" style="display: none;">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‰∏ãÂçäÈÉ®ÂàÜÔºöÊéßÂà∂Âå∫Âüü -->
                <div class="row g-3">
                    <!-- ÈöêËóèÁöÑÁä∂ÊÄÅÂíå‰∏ãËΩΩÊåâÈíÆÔºå‰øùÁïôÂäüËÉΩ -->
                    <div class="col-12" style="display: none;">
                        <div class="text-center">
                            <!-- ÈöêËóèÁöÑÁä∂ÊÄÅÂíå‰∏ãËΩΩÊåâÈíÆÔºå‰øùÁïôÂäüËÉΩ -->
                            <div style="display: none;">
                                <span class="badge px-3 py-2" id="statusBadge">ÂáÜÂ§áÂ∞±Áª™</span>
                                <button class="btn btn-primary btn-lg w-100 mt-2" id="downloadBtn" style="display: none;">
                                    <i class="bi bi-download me-2"></i>‰∏ãËΩΩÈü≥È¢ëÊñá‰ª∂
                                </button>
                            </div>
                        </div>
                    </div>


                    <!-- Èü≥È¢ëÊí≠ÊîæÂô®Âå∫ - ÁªÑ‰ª∂Âåñ -->
                    <div id="audioPlayerSection"></div>

                    <!-- Êó•ÂøóÂ±ïÁ§∫Âå∫ - ÁªÑ‰ª∂Âåñ -->
                    <div id="logDisplaySection"></div>

                    <!-- ‰ΩøÁî®ËØ¥ÊòéÂå∫ -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i>‰ΩøÁî®ËØ¥Êòé</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <h6 class="fw-bold text-primary">1. ‰ΩøÁî®ËØ¥Êòé</h6>
                                            <p class="mb-2">Êú¨ÁΩëÁ´ô‰ªÖÁî®‰∫éÊµãËØï‰ΩìÈ™åÔºåÂú®Á∫ø‰∫∫Êï∞Â§öÊó∂Â∞ÜËá™Âä®ÈôêÊµÅÔºåÂ¶ÇÊûúÈïøÊúüÂïÜ‰∏öÂåñ‰ΩøÁî®ÔºåËØ∑‰∏ãËΩΩÂºÄÊ∫êÁâàÊú¨Ëá™Ë°åÈÉ®ÁΩ≤ <a href="https://github.com/backearth1/MiniMax_TTS_Translation" target="_blank" class="text-decoration-none">https://github.com/backearth1/MiniMax_TTS_Translation</a></p>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6 class="fw-bold text-primary">2. APIÈÖçÁΩÆ</h6>
                                            <p class="mb-2">ËØ∑Âà∞<a href="https://platform.minimaxi.com" target="_blank" class="text-decoration-none">MiniMaxÂºÄÊîæÂπ≥Âè∞</a>Ê≥®ÂÜåËé∑Âèñapi_keyÔºåÂú∞ÂùÄ "https://platform.minimaxi.com", ‰ΩøÁî®ÈóÆÈ¢òËØ∑ËÅîÁ≥ªMiniMaxÊäÄÊúØÊîØÊåÅÊàñÈÇÆ‰ª∂<a href="mailto:devin@minimaxi.com" class="text-decoration-none">devin@minimaxi.com</a></p>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6 class="fw-bold text-primary">3. Âª∫ËÆÆÊµÅÁ®ã</h6>
                                            <ol class="mb-2">
                                                <li>‰∏ä‰º†SRTÊñá‰ª∂</li>
                                                <li>ÁºñËæë‰ºòÂåñSRTÁöÑÊñáÊú¨ÔºåËßíËâ≤ÔºåÊÉÖÁª™Á≠â</li>
                                                <li>ÊâπÈáèÁîüÊàê</li>
                                                <li>ÂêàÊàêÈ¢ÑËßàÔºåÊ†πÊçÆÊïàÊûúÔºåÂÜçËøîÂõû‰ºòÂåñÊñáÊú¨</li>
                                            </ol>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6 class="fw-bold text-primary">4. ‰∏ÄÈîÆÁøªËØëÂäüËÉΩ</h6>
                                            <p class="mb-2">ÁÇπÂáª"‰∏ÄÈîÆÁøªËØë"ÊåâÈíÆÂèØËá™Âä®ÂÆåÊàê‰ª•‰∏ãÊµÅÁ®ãÔºö</p>
                                            <ol class="mb-2">
                                                <li><strong>ÊâπÈáèÁøªËØë</strong>ÔºöÂ∞ÜÂéüÊñáÁøªËØë‰∏∫ÁõÆÊ†áËØ≠Ë®Ä</li>
                                                <li><strong>ÊâπÈáèTTS</strong>Ôºö‰∏∫ÁøªËØëÂêéÁöÑÊñáÊú¨ÁîüÊàêËØ≠Èü≥</li>
                                                <li><strong>ÊãºÊé•Èü≥È¢ë</strong>ÔºöÂ∞ÜÊâÄÊúâÈü≥È¢ëÁâáÊÆµÊãºÊé•‰∏∫ÂÆåÊï¥Êñá‰ª∂</li>
                                            </ol>
                                            <p class="mb-2"><small class="text-muted">Ê≥®ÊÑèÔºö‰∏ÄÈîÆÁøªËØë‰ºö‰ΩøÁî®ÂΩìÂâçÈÖçÁΩÆÁöÑËØ≠Ë®ÄËÆæÁΩÆÔºåËØ∑Á°Æ‰øùÂ∑≤Ê≠£Á°ÆÈÖçÁΩÆAPIÂèÇÊï∞</small></p>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6 class="fw-bold text-primary">5. ÊâπÈáèTTSÊó∂Èó¥Êà≥ÂØπÈΩêÂ§ÑÁêÜÈÄªËæë</h6>
                                            <p class="mb-2">Á≥ªÁªü‰ºöËá™Âä®Â§ÑÁêÜTTSÁîüÊàêÈü≥È¢ë‰∏éÂ≠óÂπïÊó∂Èó¥Êà≥ÁöÑÂØπÈΩêÈóÆÈ¢òÔºö</p>
                                            <ul class="mb-2">
                                                <li><strong>ÁøªËØë‰ºòÂåñ</strong>ÔºöÂΩìÂä†ÈÄüÊØî‰æã > 1.3 Êó∂ÔºåÁ≥ªÁªü‰ºöÂ∞ùËØïÈáçÊñ∞ÁøªËØëÊñáÊú¨‰ª•Áº©Áü≠ÂÜÖÂÆπ</li>
                                                <li><strong>ÈÄüÂ∫¶Ë∞ÉÊï¥</strong>ÔºöÂΩìÂä†ÈÄüÊØî‰æã ‚â§ 1.3 ÊàñÁøªËØë‰ºòÂåñÊó†ÊïàÊó∂Ôºå‰ºöÈÄêÊ≠•Ë∞ÉÊï¥ËØ≠ÈÄüÂèÇÊï∞Ôºà1.0 ‚Üí 1.2 ‚Üí 1.4 ‚Üí 2.0Ôºâ</li>
                                                <li><strong>Â§±Ë¥•Â§ÑÁêÜ</strong>ÔºöÂΩìÈÄüÂ∫¶ËææÂà∞2.0‰∏îÊØî‰æã‰ªç > 1.0Êó∂ÔºåËØ•ÊÆµËêΩ‰ºöË¢´Ê†áËÆ∞‰∏∫Â§±Ë¥•Âπ∂‰ΩøÁî®ÈùôÈü≥</li>
                                                <li><strong>ÊâãÂä®‰ºòÂåñ</strong>ÔºöÂª∫ËÆÆÊ†πÊçÆÂÆûÈôÖÊïàÊûúÊâãÂä®Ë∞ÉÊï¥ÊñáÊú¨ÈïøÂ∫¶Ôºå‰ª•Ëé∑ÂæóÊúÄ‰Ω≥ÂØπÈΩêÊïàÊûú</li>
                                            </ul>
                                            <p class="mb-2"><small class="text-muted">Ê≥®ÔºöÂä†ÈÄüÊØî‰æã = TTSÈü≥È¢ëÊó∂Èïø / Â≠óÂπïÊó∂ÈïøÔºåÊØî‰æã ‚â§ 1.0 Ë°®Á§∫Èü≥È¢ëÊó∂ÈïøÂú®Â≠óÂπïÊó∂ÈïøËåÉÂõ¥ÂÜÖ</small></p>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6 class="fw-bold text-primary">6. SRTÊ†ºÂºèÊîØÊåÅ</h6>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <h6 class="fw-bold text-success">ÊúâÂ∫èÂè∑</h6>
                                                    <pre class="bg-light p-2 rounded small">1
00:00:06.879 --> 00:00:11.039
Âó®Ôºå‰Ω†Â•ΩÂïä</pre>
                                                </div>
                                                <div class="col-md-4">
                                                    <h6 class="fw-bold text-success">Êó†Â∫èÂè∑</h6>
                                                    <pre class="bg-light p-2 rounded small">00:00:06.879 --> 00:00:11.039
Âó®Ôºå‰Ω†Â•ΩÂïä</pre>
                                                </div>
                                                <div class="col-md-4">
                                                    <h6 class="fw-bold text-success">ÂÆåÊï¥Ê†áÊ≥®</h6>
                                                    <pre class="bg-light p-2 rounded small">1
[00:00:06.879 --> 00:00:11.039] SPEAKER_00 [emotion: happy]
Âó®Ôºå‰Ω†Â•ΩÂïä</pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê®°ÊÄÅÊ°ÜÂå∫Âüü - ÁªÑ‰ª∂Âåñ -->
    <div id="modalsSection"></div>


    <!-- Toast ÈÄöÁü• -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-bell-fill me-2"></i>
                <strong class="me-auto">Á≥ªÁªüÈÄöÁü•</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
                <!-- Toast ÂÜÖÂÆπ -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/core.js"></script>
    <script src="/static/js/component-loader.js"></script>
    <script src="/static/js/app.js"></script>
    <script src="/static/js/project-manager.js"></script>
    <script src="/static/js/progress-tracker.js"></script>
    <script src="/static/js/text-adjuster.js"></script>
    <script src="/static/js/inline-editor.js"></script>
    <script>
        // ÂØºÂá∫SRTÊñá‰ª∂ÂáΩÊï∞
        async function exportSrtFile() {
            if (!currentSubtitleProject) {
                showToast('ËØ∑ÂÖà‰∏ä‰º†SRTÊñá‰ª∂');
                return;
            }

            try {
                // ‰ΩøÁî®‰∏ìÈó®ÁöÑÂØºÂá∫API
                const response = await fetch(`/api/subtitle/${currentSubtitleProject.id}/export-srt`);
                const result = await response.json();
                
                if (result.success && result.srt_content) {
                    // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                    const blob = new Blob([result.srt_content], { type: 'text/plain;charset=utf-8' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = result.filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showToast('SRTÊñá‰ª∂ÂØºÂá∫ÊàêÂäüÔºÅ');
                } else {
                    showToast('ÂØºÂá∫Â§±Ë¥•: ' + (result.message || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                console.error('ÂØºÂá∫SRTÂ§±Ë¥•:', error);
                showToast('ÂØºÂá∫Â§±Ë¥•: ' + error.message);
            }
        }
    </script>
    <script>
        // ÂêàÂπ∂Â≠óÂπïÁºñËæëÂäüËÉΩÂà∞‰∏ªÈ°µÈù¢
        let currentSubtitleProject = null;
        let currentPage = 1;
        let segments = [];

        // ÁÆÄÂåñ‰∏ä‰º†SRTÂäüËÉΩ
        document.getElementById('quickSrtUpload').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleQuickSrtUpload(e.target.files[0]);
            }
        });

        async function handleQuickSrtUpload(file) {
            if (!file.name.toLowerCase().endsWith('.srt')) {
                showToast('ËØ∑ÈÄâÊã©SRTÊ†ºÂºèÊñá‰ª∂');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('clientId', app.clientId); // Ê∑ªÂä†ÁúüÂÆûÁöÑclientId

                const response = await fetch('/api/parse-subtitle', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    currentSubtitleProject = result.project;
                    currentPage = 1; // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
                    loadSubtitleSegments();
                    
                    // ÊòæÁ§∫ÂØºÂá∫ÊåâÈíÆ
                    document.getElementById('exportSrtBtn').style.display = 'inline-block';
                    
                    // ÂêåÊó∂ËÆæÁΩÆÂà∞ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ•‰∏≠ÔºåÁî®‰∫éÂÖºÂÆπÁé∞ÊúâÁîüÊàêÈÄªËæë
                    const hiddenFileInput = document.getElementById('subtitleFile');
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    hiddenFileInput.files = dt.files;
                    
                    showToast(`Ëß£ÊûêÊàêÂäüÔºÅ${result.project.total_segments} ‰∏™ÊÆµËêΩÔºåÊØèÈ°µÊòæÁ§∫20Êù°`);
                } else {
                    showToast('Ëß£ÊûêÂ§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                showToast('‰∏ä‰º†Â§±Ë¥•: ' + error.message);
            }
        }

        async function loadSubtitleSegments() {
            if (!currentSubtitleProject) return;

            try {
                const response = await fetch(`/api/subtitle/${currentSubtitleProject.id}/segments?page=${currentPage}&per_page=20`);
                const result = await response.json();

                if (result.success) {
                    segments = result.segments;
                    renderSubtitleSegments();
                    updatePaginationInfo(result.pagination);
                    
                    // ÊòæÁ§∫ÁøªËØëÂäüËÉΩÂå∫Âüü
                    const translationSection = document.getElementById('translationSection');
                    if (translationSection) {
                        translationSection.style.display = 'flex';
                    }
                    
                    // ÊòæÁ§∫ÂØºÂá∫SRTÊåâÈíÆ
                    const exportSrtBtn = document.getElementById('exportSrtBtn');
                    if (exportSrtBtn) {
                        exportSrtBtn.style.display = 'inline-block';
                    }
                    
                    // Á°Æ‰øùÊâπÈáèÊìç‰ΩúÂå∫ÂüüÂ∑≤ÂàùÂßãÂåñ‰ΩÜÈöêËóè
                    const batchOperationSection = document.getElementById('batchOperationSection');
                    if (batchOperationSection && segments.length > 0) {
                        // ‰∏çË¶ÅËá™Âä®ÊòæÁ§∫ÔºåÁ≠âÁî®Êà∑ÈÄâÊã©Êó∂ÂÜçÊòæÁ§∫
                        updateSelectedCount();
                    }
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊÆµËêΩÂ§±Ë¥•:', error);
            }
        }

        function updatePaginationInfo(pagination) {
            if (!pagination) return;
            
            const pageInfo = document.getElementById('pageInfo');
            const paginationControls = document.getElementById('paginationControls');
            const prevPage = document.getElementById('prevPage');
            const nextPage = document.getElementById('nextPage');
            
            if (pageInfo) {
                pageInfo.textContent = `Á¨¨ ${pagination.page} È°µÔºåÂÖ± ${pagination.pages} È°µ (${pagination.total} Êù°ÔºåÊØèÈ°µ20Êù°)`;
            }
            
            // ÊòæÁ§∫ÂàÜÈ°µÊéßÂà∂
            if (pagination.pages > 1) {
                paginationControls.style.display = 'flex';
                prevPage.disabled = pagination.page <= 1;
                nextPage.disabled = pagination.page >= pagination.pages;
            } else {
                paginationControls.style.display = 'none';
            }
        }

        function renderSubtitleSegments() {
            const container = document.getElementById('subtitleEditor');
            
            if (segments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5" style="color: var(--pink-400);">
                        <i class="bi bi-file-earmark-text fs-1"></i>
                        <p class="mt-2">‰∏ä‰º†SRTÊñá‰ª∂ÂºÄÂßãÁºñËæë</p>
                    </div>
                `;
                return;
            }

            const segmentsHtml = segments.map((segment, index) => `
                <div class="segment-item">
                    <div class="d-flex flex-column">
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <input type="checkbox" class="form-check-input segment-checkbox" 
                                   data-segment-id="${segment.id}" 
                                   onchange="updateSelectedCount()"
                                   style="margin-right: 8px;">
                            <span class="badge" style="background: var(--pink-400);">${segment.index}</span>
                            <small style="color: var(--pink-600);">${segment.start_time} ‚Üí ${segment.end_time}</small>
                            <span class="speaker-simple">${segment.speaker}</span>
                            <span class="emotion-simple">${segment.emotion}</span>
                            <small style="color: var(--pink-600);">√ó${segment.speed}</small>
                            <div class="btn-group btn-group-sm ms-auto" role="group">
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="generateTTS('${segment.id}')" 
                                        title="ÁîüÊàêTTS"
                                        style="width: 70px; min-width: 70px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; white-space: nowrap;">
                                    ÁîüÊàê
                                </button>
                                <button class="btn btn-outline-success btn-sm" 
                                        onclick="playAudio('${segment.id}')" 
                                        ${segment.audio_url && segment.audio_url !== '' ? '' : 'disabled'}
                                        title="Êí≠ÊîæÈü≥È¢ë"
                                        style="width: 40px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-play-circle"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info insert-segment-btn" 
                                        data-segment-id="${segment.id}"
                                        title="Âú®Ê≠§ÊÆµËêΩÂêéÊèíÂÖ•Êñ∞ÊÆµËêΩ"
                                        style="width: 40px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteSegment('${segment.id}')"
                                        title="Âà†Èô§ÊÆµËêΩ"
                                        style="width: 40px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="d-flex">
                            <div class="flex-grow-1">
                                <div class="mb-1">
                                    <small style="color: var(--pink-700); font-weight: 500;">ÂéüÊñá: ${segment.text}</small>
                                </div>
                                ${segment.translated_text ? 
                                    `<div class="mb-1 d-flex align-items-center">
                                        <small style="color: var(--blue-600); font-weight: 500;" class="translation-text">ËØëÊñá: ${segment.translated_text}</small>
                                        <div class="text-adjustment-buttons d-inline-flex gap-1 ms-2">
                                            <button type="button" class="btn btn-outline-primary btn-sm text-adjust-btn" 
                                                    data-segment-id="${segment.id}" 
                                                    data-adjustment-type="shorten"
                                                    title="Áº©Áü≠ËØëÊñáÁ∫¶20%"
                                                    onclick="adjustSegmentText('${segment.id}', 'shorten')">
                                                <i class="bi bi-arrow-down-circle me-1"></i>Áº©Áü≠
                                            </button>
                                            <button type="button" class="btn btn-outline-success btn-sm text-adjust-btn"
                                                    data-segment-id="${segment.id}"
                                                    data-adjustment-type="lengthen"
                                                    title="Âä†ÈïøËØëÊñáÁ∫¶20%"
                                                    onclick="adjustSegmentText('${segment.id}', 'lengthen')">
                                                <i class="bi bi-arrow-up-circle me-1"></i>Âä†Èïø
                                            </button>
                                        </div>
                                    </div>` : 
                                    `<div class="mb-1 d-flex align-items-center">
                                        <small style="color: var(--gray-500); font-style: italic;">ËØëÊñá: Êú™ÁøªËØë</small>
                                        <div class="text-adjustment-buttons d-inline-flex gap-1 ms-2">
                                            <small class="text-muted fst-italic">ÈúÄË¶ÅÂÖàÁøªËØë</small>
                                        </div>
                                    </div>`
                                }
                            </div>
                            <div class="ms-2" style="min-width: 120px;">
                                ${segment.trace_id && !segment.trace_id.startsWith('test_') ? `<small class="text-muted" title="${segment.trace_id}">Trace: ${segment.trace_id}</small>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = segmentsHtml;
            
            // ÈáçÊñ∞Ê∏≤ÊüìÂêéÔºåÁ°Æ‰øùÂÜÖËÅîÁºñËæëÂô®ÈáçÊñ∞ÂàùÂßãÂåñ
            if (window.inlineEditor) {
                // Âª∂ËøüÊâßË°åÔºåÁ°Æ‰øùDOMÂÆåÂÖ®Êõ¥Êñ∞
                setTimeout(() => {
                    console.log('üîß ÊâãÂä®ÈáçÊñ∞ÂàùÂßãÂåñÂÜÖËÅîÁºñËæëÂô®');
                    window.inlineEditor.enhanceAllSegments();
                }, 50);
            }
        }

        // TTSÁîüÊàêÂáΩÊï∞
        async function generateTTS(segmentId) {
            if (!currentSubtitleProject) {
                showToast('ËØ∑ÂÖà‰∏ä‰º†SRTÊñá‰ª∂');
                return;
            }

            const segment = segments.find(s => s.id === segmentId);
            if (!segment) {
                showToast('Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑÊÆµËêΩ');
                return;
            }

            addLog(`ÂºÄÂßãÁîüÊàêTTS: ÊÆµËêΩ${segmentId}`);

            try {
                // Ëé∑ÂèñÂΩìÂâçÈÖçÁΩÆ
                const groupId = document.getElementById('groupId').value;
                const apiKey = document.getElementById('apiKey').value;
                const model = document.getElementById('voiceModel').value;
                const language = document.getElementById('language').value;
                
                // Ëé∑ÂèñvoiceMappingÔºà‰ªéÂä®ÊÄÅÁîüÊàêÁöÑÂÖÉÁ¥†‰∏≠Ôºâ
                const voiceMapping = getVoiceMapping();

                if (!groupId || !apiKey) {
                    addLog('ÈÖçÁΩÆÈîôËØØ: Áº∫Â∞ëGroup IDÊàñAPI Key');
                    showToast('ËØ∑ÂÖàÈÖçÁΩÆGroup IDÂíåAPI Key');
                    return;
                }

                addLog(`Ë∞ÉÁî®TTS API: Ê®°Âûã=${model}, ËØ¥ËØù‰∫∫=${segment.speaker}, ÊÉÖÁª™=${segment.emotion}`);
                showToast('Ê≠£Âú®ÁîüÊàêTTS...');

                const formData = new FormData();
                formData.append('groupId', groupId);
                formData.append('apiKey', apiKey);
                formData.append('apiEndpoint', document.getElementById('apiEndpoint').value);
                formData.append('model', model);
                formData.append('language', language);
                formData.append('voiceMapping', JSON.stringify(voiceMapping));

                const response = await fetch(`/api/subtitle/${currentSubtitleProject.id}/segment/${segmentId}/generate-tts`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    const traceInfo = result.trace_id ? `, trace_id=${result.trace_id}` : '';
                    const ratioInfo = result.duration_ratio ? `, ÊØî‰æã=${result.duration_ratio.toFixed(2)}` : '';
                    addLog(`TTSÁîüÊàêÊàêÂäü: ÊÆµËêΩ${segmentId}${traceInfo}${ratioInfo}`);
                    showToast('TTSÁîüÊàêÊàêÂäüÔºÅ');
                    // ÈáçÊñ∞Âä†ËΩΩÊÆµËêΩ‰ª•Êõ¥Êñ∞Áä∂ÊÄÅ
                    loadSubtitleSegments();
                } else {
                    // ÁîüÊàêÂ§±Ë¥•ÔºåËÆ∞ÂΩïËØ¶ÁªÜ‰ø°ÊÅØ‰ΩÜ‰∏çÊõ¥Êñ∞ÁïåÈù¢
                    const traceInfo = result.trace_id ? `, trace_id=${result.trace_id}` : '';
                    const ratioInfo = result.duration_ratio ? `, ÊØî‰æã=${result.duration_ratio.toFixed(2)}` : '';
                    const durationInfo = result.target_duration && result.current_duration ? 
                        `, ÁõÆÊ†áÊó∂Èïø=${result.target_duration}ms, ÂΩìÂâçÊó∂Èïø=${result.current_duration}ms` : '';
                    
                    addLog(`TTSÁîüÊàêÂ§±Ë¥•: ÊÆµËêΩ${segmentId}${traceInfo}${ratioInfo}${durationInfo}`);
                    addLog(`Â§±Ë¥•ÂéüÂõ†: ${result.message}`);
                    showToast('TTSÁîüÊàêÂ§±Ë¥•: ' + result.message);
                    // ‰∏çÈáçÊñ∞Âä†ËΩΩÊÆµËêΩÔºå‰øùÊåÅÂéüÊúâÁä∂ÊÄÅ
                }
            } catch (error) {
                console.error('TTSÁîüÊàêÂ§±Ë¥•:', error);
                addLog(`TTSÁîüÊàêÂ§±Ë¥•: ÊÆµËêΩ${segmentId}, ÈîôËØØ=${error.message}`);
                showToast('TTSÁîüÊàêÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÁîüÊàêÂÆ¢Êà∑Á´ØID
        function generateClientId() {
            return 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Ê∑ªÂä†Êñ∞ÊÆµËêΩ
        async function addNewSegment() {
            if (!currentSubtitleProject) {
                showToast('ËØ∑ÂÖà‰∏ä‰º†SRTÊñá‰ª∂');
                return;
            }

            // ÁîüÊàêÊñ∞ÁöÑÊÆµËêΩID
            const newSegmentId = 'segment_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // ËÆ°ÁÆóÊñ∞ÁöÑÊó∂Èó¥Êà≥ÔºàÂú®ÊúÄÂêé‰∏Ä‰∏™ÊÆµËêΩ‰πãÂêéÔºâ
            let newStartTime = '00:00:00,000';
            let newEndTime = '00:00:05,000';
            
            if (segments.length > 0) {
                const lastSegment = segments[segments.length - 1];
                // Ëß£ÊûêÊúÄÂêé‰∏Ä‰∏™ÊÆµËêΩÁöÑÁªìÊùüÊó∂Èó¥
                const lastEndTime = lastSegment.end_time;
                const [hours, minutes, seconds] = lastEndTime.split(':');
                const [secs, ms] = seconds.split(',');
                
                // ËÆ°ÁÆóÊñ∞ÁöÑÂºÄÂßãÊó∂Èó¥ÔºàÂú®ÊúÄÂêé‰∏Ä‰∏™ÊÆµËêΩÁªìÊùüÂêéÔºâ
                const totalSeconds = parseInt(hours) * 3600 + parseInt(minutes) * 60 + parseInt(secs) + parseInt(ms) / 1000;
                const newStartSeconds = totalSeconds + 0.5; // Ê∑ªÂä†0.5ÁßíÈó¥Èöî
                const newEndSeconds = newStartSeconds + 5; // ÈªòËÆ§5ÁßíÊó∂Èïø
                
                newStartTime = formatTime(newStartSeconds);
                newEndTime = formatTime(newEndSeconds);
            }

            // ÂàõÂª∫Êñ∞ÊÆµËêΩÂØπË±°
            const newSegment = {
                id: newSegmentId,
                index: segments.length + 1,
                start_time: newStartTime,
                end_time: newEndTime,
                speaker: 'SPEAKER_00',
                emotion: 'neutral',
                speed: 1.0,
                text: 'ËØ∑ËæìÂÖ•ÊñáÊú¨ÂÜÖÂÆπ',
                translated_text: '',
                audio_data: null,
                audio_duration: 0,
                audio_url: '',
                trace_id: '',
                updated_at: new Date().toISOString()
            };

            try {
                // ÈÄöËøáAPIÊ∑ªÂä†ÊÆµËêΩ
                const response = await fetch(`/api/subtitle/${currentSubtitleProject.id}/segment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newSegment)
                });

                const result = await response.json();

                if (result.success) {
                    addLog(`Ê∑ªÂä†Êñ∞ÊÆµËêΩ: ${newSegmentId}`);
                    showToast('Êñ∞ÊÆµËêΩÂ∑≤Ê∑ªÂä†');
                    
                    // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÈ°µÈù¢Ôºå‰øùÊåÅÂàÜÈ°µ
                    await loadSubtitleSegments();
                } else {
                    showToast('Ê∑ªÂä†ÊÆµËêΩÂ§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('Ê∑ªÂä†ÊÆµËêΩÂ§±Ë¥•:', error);
                showToast('Ê∑ªÂä†ÊÆµËêΩÂ§±Ë¥•: ' + error.message);
            }
        }

        // Âú®ÊåáÂÆö‰ΩçÁΩÆÊèíÂÖ•Êñ∞ÊÆµËêΩ
        async function insertAfterSegment(segmentId) {
            if (!currentSubtitleProject) {
                showToast('ËØ∑ÂÖà‰∏ä‰º†SRTÊñá‰ª∂');
                return;
            }

            // Ê†πÊçÆsegmentIdÊâæÂà∞ÂØπÂ∫îÁöÑÊÆµËêΩÂíåÁ¥¢Âºï
            const afterIndex = segments.findIndex(seg => seg.id === segmentId);
            if (afterIndex === -1) {
                showToast('Êâæ‰∏çÂà∞ÁõÆÊ†áÊÆµËêΩ');
                return;
            }
            

            // ÁîüÊàêÊñ∞ÁöÑÊÆµËêΩID
            const newSegmentId = 'segment_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // ËÆ°ÁÆóÊèíÂÖ•‰ΩçÁΩÆÁöÑÊó∂Èó¥Êà≥
            const currentSegment = segments[afterIndex];
            const nextSegment = segments[afterIndex + 1];
            
            let newStartTime, newEndTime;
            
            if (nextSegment) {
                // Âú®‰∏§‰∏™ÊÆµËêΩ‰πãÈó¥ÊèíÂÖ•
                const currentEndTime = currentSegment.end_time;
                const nextStartTime = nextSegment.start_time;
                
                
                // ËÆ°ÁÆó‰∏≠Èó¥Êó∂Èó¥ - ÊîØÊåÅ‰∏§ÁßçÊó∂Èó¥Ê†ºÂºèÔºöHH:MM:SS,mmm Âíå HH:MM:SS.mmm
                const [hours1, minutes1, seconds1] = currentEndTime.split(':');
                const [secs1, ms1] = seconds1.includes(',') ? seconds1.split(',') : seconds1.split('.');
                const currentEndSeconds = parseInt(hours1) * 3600 + parseInt(minutes1) * 60 + parseInt(secs1) + parseInt(ms1) / 1000;
                
                const [hours2, minutes2, seconds2] = nextStartTime.split(':');
                const [secs2, ms2] = seconds2.includes(',') ? seconds2.split(',') : seconds2.split('.');
                const nextStartSeconds = parseInt(hours2) * 3600 + parseInt(minutes2) * 60 + parseInt(secs2) + parseInt(ms2) / 1000;
                
                const middleTime = (currentEndSeconds + nextStartSeconds) / 2;
                const newStartSeconds = middleTime - 2.5; // Êñ∞ÊÆµËêΩÂºÄÂßãÊó∂Èó¥
                const newEndSeconds = middleTime + 2.5; // Êñ∞ÊÆµËêΩÁªìÊùüÊó∂Èó¥
                
                newStartTime = formatTime(newStartSeconds);
                newEndTime = formatTime(newEndSeconds);
            } else {
                // Âú®ÊúÄÂêé‰∏Ä‰∏™ÊÆµËêΩ‰πãÂêéÊèíÂÖ•
                const lastEndTime = currentSegment.end_time;
                const [hours, minutes, seconds] = lastEndTime.split(':');
                const [secs, ms] = seconds.includes(',') ? seconds.split(',') : seconds.split('.');
                
                const totalSeconds = parseInt(hours) * 3600 + parseInt(minutes) * 60 + parseInt(secs) + parseInt(ms) / 1000;
                const newStartSeconds = totalSeconds + 0.5;
                const newEndSeconds = newStartSeconds + 5;
                
                newStartTime = formatTime(newStartSeconds);
                newEndTime = formatTime(newEndSeconds);
            }

            // ÂàõÂª∫Êñ∞ÊÆµËêΩÂØπË±°
            const newSegment = {
                id: newSegmentId,
                index: afterIndex + 2, // ‰∏¥Êó∂Â∫èÂè∑ÔºåÂêéÈù¢‰ºöÊõ¥Êñ∞
                start_time: newStartTime,
                end_time: newEndTime,
                speaker: 'SPEAKER_00',
                emotion: 'neutral',
                speed: 1.0,
                text: 'ËØ∑ËæìÂÖ•ÊñáÊú¨ÂÜÖÂÆπ',
                translated_text: '',
                audio_data: null,
                audio_duration: 0,
                audio_url: '',
                trace_id: '',
                updated_at: new Date().toISOString(),
                insert_after_segment_id: segmentId  // ‰ΩøÁî®ÊÆµËêΩIDËÄåÈùûÁ¥¢Âºï
            };

            try {
                // ÈÄöËøáAPIÊ∑ªÂä†ÊÆµËêΩ
                const response = await fetch(`/api/subtitle/${currentSubtitleProject.id}/segment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newSegment)
                });

                const result = await response.json();

                if (result.success) {
                    addLog(`Âú®ÊÆµËêΩ ${currentSegment.index} ÂêéÊèíÂÖ•Êñ∞ÊÆµËêΩ: ${newSegmentId}`);
                    showToast(`Êñ∞ÊÆµËêΩÂ∑≤ÊèíÂÖ•Âà∞ÊÆµËêΩ ${currentSegment.index} ‰πãÂêé`);
                    
                    // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÈ°µÈù¢Ôºå‰øùÊåÅÂàÜÈ°µ
                    await loadSubtitleSegments();
                } else {
                    showToast('ÊèíÂÖ•ÊÆµËêΩÂ§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('ÊèíÂÖ•ÊÆµËêΩÂ§±Ë¥•:', error);
                showToast('ÊèíÂÖ•ÊÆµËêΩÂ§±Ë¥•: ' + error.message);
            }
        }

        // Âà†Èô§ÊÆµËêΩ
        async function deleteSegment(segmentId) {
            if (!currentSubtitleProject) {
                showToast('ËØ∑ÂÖà‰∏ä‰º†SRTÊñá‰ª∂');
                return;
            }

            const segmentIndex = segments.findIndex(s => s.id === segmentId);
            if (segmentIndex === -1) {
                showToast('Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑÊÆµËêΩ');
                return;
            }

            // Á°ÆËÆ§Âà†Èô§
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÊÆµËêΩ ${segments[segmentIndex].index} ÂêóÔºü`)) {
                return;
            }

            try {
                // ÈÄöËøáAPIÂà†Èô§ÊÆµËêΩ
                const response = await fetch(`/api/subtitle/${currentSubtitleProject.id}/segment/${segmentId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    addLog(`Âà†Èô§ÊÆµËêΩ: ${segmentId}`);
                    showToast('ÊÆµËêΩÂ∑≤Âà†Èô§');
                    
                    // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÈ°µÈù¢Ôºå‰øùÊåÅÂàÜÈ°µ
                    await loadSubtitleSegments();
                } else {
                    showToast('Âà†Èô§ÊÆµËêΩÂ§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('Âà†Èô§ÊÆµËêΩÂ§±Ë¥•:', error);
                showToast('Âà†Èô§ÊÆµËêΩÂ§±Ë¥•: ' + error.message);
            }
        }

        // Êõ¥Êñ∞ÊÆµËêΩÂ∫èÂè∑
        function updateSegmentIndexes() {
            segments.forEach((segment, index) => {
                segment.index = index + 1;
            });
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥ÂáΩÊï∞
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')},${ms.toString().padStart(3, '0')}`;
        }

        // Ëé∑ÂèñvoiceMappingÁöÑÂáΩÊï∞
        function getVoiceMapping() {
            const mapping = {};
            
            // ‰ªéÊñ∞ÁöÑHTMLÁªìÊûÑ‰∏≠Ëé∑ÂèñÈªòËÆ§ËØ≠Èü≥ÈÖçÁΩÆ
            const speakers = ['SPEAKER_00', 'SPEAKER_01', 'SPEAKER_02', 'SPEAKER_03', 'SPEAKER_04', 'SPEAKER_05'];
            
            speakers.forEach(speaker => {
                const elementId = `speaker${speaker.slice(-2)}Voice`;
                const selectElement = document.getElementById(elementId);
                
                if (selectElement) {
                    const voice = selectElement.value;
                    if (voice) {
                        mapping[speaker] = voice;
                    }
                }
            });

            // Ê∑ªÂä†Ëá™ÂÆö‰πâËßíËâ≤ËØ≠Èü≥ÈÖçÁΩÆ
            const customInputs = document.querySelectorAll('[id^="customSpeaker_"]');
            customInputs.forEach(input => {
                const speakerName = input.dataset.speakerName;
                const voiceId = input.value;
                if (speakerName && voiceId) {
                    mapping[speakerName] = voiceId;
                }
            });

            return mapping;
        }

        // Èü≥È¢ëÊí≠ÊîæÂáΩÊï∞
        function playAudio(segmentId) {
            const segment = segments.find(s => s.id === segmentId);
            if (!segment || !segment.audio_url || segment.audio_url === '') {
                showToast('Ê≤°ÊúâÂèØÊí≠ÊîæÁöÑÈü≥È¢ë');
                return;
            }

            try {
                const audio = new Audio(segment.audio_url);
                audio.play().catch(error => {
                    console.error('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', error);
                    showToast('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•: ' + error.message);
                });
            } catch (error) {
                console.error('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', error);
                showToast('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÊâπÈáèÁîüÊàêTTS
        async function batchGenerateTTS() {
            if (!currentSubtitleProject) {
                showToast('ËØ∑ÂÖà‰∏ä‰º†SRTÊñá‰ª∂');
                return;
            }
            
            const groupId = document.getElementById('groupId').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('voiceModel').value;
            const language = document.getElementById('language').value;
            const voiceMapping = getVoiceMapping();
            
            if (!groupId || !apiKey) {
                addLog('ÈÖçÁΩÆÈîôËØØ: Áº∫Â∞ëGroup IDÊàñAPI Key');
                showToast('ËØ∑ÂÖàÈÖçÁΩÆGroup IDÂíåAPI Key');
                return;
            }
            
            if (Object.keys(voiceMapping).length === 0) {
                addLog('ÈÖçÁΩÆÈîôËØØ: Áº∫Â∞ëËßíËâ≤ËØ≠Èü≥Êò†Â∞Ñ');
                showToast('ËØ∑ÂÖàÈÖçÁΩÆËßíËâ≤ËØ≠Èü≥Êò†Â∞Ñ');
                return;
            }
            
            addLog(`ÂºÄÂßãÊâπÈáèÁîüÊàêTTS: È°πÁõÆ${currentSubtitleProject.id}, ÊÄªÊÆµËêΩÊï∞=${segments.length}`);
            
            // Á¶ÅÁî®ÊåâÈíÆ
            const batchTTSBtn = document.getElementById('batchTTSBtn');
            const originalText = batchTTSBtn.innerHTML;
            batchTTSBtn.disabled = true;
            batchTTSBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Ê≠£Âú®ÁîüÊàê...';
            
            // ÂºÄÂßãÂÆûÊó∂Êó•ÂøóÊõ¥Êñ∞
            const clientId = generateClientId();
            currentOperationClientId = clientId;
            let logUpdateInterval;
            
            try {
                addLog(`Ë∞ÉÁî®ÊâπÈáèTTS API: Ê®°Âûã=${model}, ËØ≠Ë®Ä=${language}`);
                showToast('ÂºÄÂßãÊâπÈáèÁîüÊàêTTS...');
                
                // ÂºÄÂßãÂÆûÊó∂Êó•ÂøóÊõ¥Êñ∞
                startRealTimeLogUpdates(clientId);
                
                const formData = new FormData();
                formData.append('groupId', groupId);
                formData.append('apiKey', apiKey);
                formData.append('apiEndpoint', document.getElementById('apiEndpoint').value);
                formData.append('model', model);
                formData.append('language', language);
                formData.append('voiceMapping', JSON.stringify(voiceMapping));
                formData.append('clientId', clientId);
                
                const response = await fetch(`/api/subtitle/${currentSubtitleProject.id}/batch-generate-tts`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // ÂÅúÊ≠¢ÂÆûÊó∂Êó•ÂøóÊõ¥Êñ∞
                stopRealTimeLogUpdates();
                
                if (result.success) {
                    const stats = result.statistics || {};
                    const total = stats.total_segments || result.updated_segments.length;
                    const successful = stats.successful_segments || result.updated_segments.length;
                    const failed = stats.failed_segments || 0;
                    const accelerated = stats.accelerated_segments || 0;
                    const maxSpeed = stats.max_speed_segments || 0;
                    
                    let message;
                    if (result.interrupted) {
                        message = `ÊâπÈáèTTSË¢´‰∏≠Êñ≠ÔºÅÂ∑≤Â§ÑÁêÜ ${successful}/${total} ‰∏™ÊÆµËêΩ`;
                        addLog(`ÊâπÈáèTTSÁîüÊàêË¢´‰∏≠Êñ≠: ${successful}/${total}‰∏™ÊÆµËêΩ, Â∑≤‰øùÂ≠òËøõÂ∫¶`);
                        showToast(message);
                    } else {
                        message = `ÊâπÈáèTTSÁîüÊàêÂÆåÊàêÔºÅÊàêÂäüÂ§ÑÁêÜ ${successful}/${total} ‰∏™ÊÆµËêΩ`;
                        if (failed > 0) {
                            message += `ÔºåÂ§±Ë¥• ${failed} ‰∏™`;
                        }
                        if (accelerated > 0) {
                            message += `ÔºåÂä†ÈÄü ${accelerated} ‰∏™`;
                        }
                        if (maxSpeed > 0) {
                            message += `ÔºåÊúÄÂ§ßÂä†ÈÄü ${maxSpeed} ‰∏™`;
                        }
                        
                        addLog(`ÊâπÈáèTTSÁîüÊàêÊàêÂäü: ${successful}/${total}‰∏™ÊÆµËêΩ`);
                        if (failed > 0) {
                            addLog(`Â§±Ë¥•ÊÆµËêΩ: ${failed}‰∏™`);
                        }
                        if (accelerated > 0) {
                            addLog(`Âä†ÈÄüÊÆµËêΩ: ${accelerated}‰∏™`);
                        }
                        if (maxSpeed > 0) {
                            addLog(`ÊúÄÂ§ßÂä†ÈÄüÊÆµËêΩ: ${maxSpeed}‰∏™`);
                        }
                        
                        // ÊòæÁ§∫ÈÄüÂ∫¶Ë∞ÉÊï¥ËØ¶ÊÉÖ
                        if (result.speed_adjustments && result.speed_adjustments.length > 0) {
                            addLog(`ÈÄüÂ∫¶Ë∞ÉÊï¥ËØ¶ÊÉÖ:`);
                            result.speed_adjustments.forEach(adjustment => {
                                addLog(`  ${adjustment}`);
                            });
                        }
                        
                        showToast(message);
                    }
                    
                    // ÈáçÊñ∞Âä†ËΩΩÂ≠óÂπïÊÆµËêΩ‰ª•Êõ¥Êñ∞Êí≠ÊîæÊåâÈíÆÂíåtrace_id
                    loadSubtitleSegments();
                } else {
                    addLog(`ÊâπÈáèTTSÁîüÊàêÂ§±Ë¥•: ${result.message}`);
                    showToast('ÊâπÈáèTTSÁîüÊàêÂ§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('ÊâπÈáèTTSÁîüÊàêÂ§±Ë¥•:', error);
                addLog(`ÊâπÈáèTTSÁîüÊàêÂ§±Ë¥•: ${error.message}`);
                showToast('ÊâπÈáèTTSÁîüÊàêÂ§±Ë¥•: ' + error.message);
            } finally {
                // ÂÅúÊ≠¢ÂÆûÊó∂Êó•ÂøóÊõ¥Êñ∞
                stopRealTimeLogUpdates();
                // ÊÅ¢Â§çÊåâÈíÆÔºåÊ∏ÖÈô§ÂÆ¢Êà∑Á´ØID
                batchTTSBtn.disabled = false;
                batchTTSBtn.innerHTML = originalText;
                currentOperationClientId = null;
            }
        }
        
        // ÂºÄÂßãÂÆûÊó∂Êó•ÂøóÊõ¥Êñ∞
        function startRealTimeLogUpdates(clientId) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
            if (window.logUpdateTimer) {
                clearInterval(window.logUpdateTimer);
            }
            
            // ËÆæÁΩÆÂÆöÊó∂Âô®ÔºåÊØè2ÁßíÊ£ÄÊü•‰∏ÄÊ¨°Êó•ÂøóÊõ¥Êñ∞
            window.logUpdateTimer = setInterval(async () => {
                try {
                    const response = await fetch(`/api/logs/${clientId}`);
                    
                    if (response.ok) {
                        const logs = await response.json();
                        
                        if (logs && logs.length > 0) {
                            // Ê∑ªÂä†Êñ∞ÁöÑÊó•ÂøóÊù°ÁõÆ
                            logs.forEach(log => {
                                if (log.message && !window.processedLogs.has(log.id)) {
                                    // ÁªÑÂêàmessageÂíådetails
                                    let logText = log.message;
                                    if (log.details && log.details.trim()) {
                                        logText += `: ${log.details}`;
                                    }
                                    
                                    // Ë∞ÉËØï‰ø°ÊÅØ - ÁâπÂà´ÂÖ≥Ê≥®ratio‰ø°ÊÅØ
                                    if (log.message.includes('Êó∂ÈïøÊØî‰æã')) {
                                        console.log('DEBUG: Êé•Êî∂Âà∞ratioÊó•Âøó', log);
                                    }
                                    
                                    addLog(logText);
                                    window.processedLogs.add(log.id);
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñÊó•ÂøóÂ§±Ë¥•:', error);
                }
            }, 2000);
            
            // ÂàùÂßãÂåñÂ∑≤Â§ÑÁêÜÊó•ÂøóÈõÜÂêà
            if (!window.processedLogs) {
                window.processedLogs = new Set();
            }
        }
        
        // ÂÅúÊ≠¢ÂÆûÊó∂Êó•ÂøóÊõ¥Êñ∞
        function stopRealTimeLogUpdates() {
            if (window.logUpdateTimer) {
                clearInterval(window.logUpdateTimer);
                window.logUpdateTimer = null;
            }
            // Ê∏ÖÁ©∫Â∑≤Â§ÑÁêÜÊó•ÂøóÈõÜÂêà
            if (window.processedLogs) {
                window.processedLogs.clear();
            }
        }

        // ÊãºÊé•Èü≥È¢ëËæìÂá∫
        async function mergeAudio() {
            if (!currentSubtitleProject) {
                showToast('ËØ∑ÂÖà‰∏ä‰º†SRTÊñá‰ª∂');
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈü≥È¢ëÊï∞ÊçÆ
            const segmentsWithAudio = segments.filter(s => s.audio_url && s.audio_url !== '');
            if (segmentsWithAudio.length === 0) {
                addLog('ÂêàÂπ∂Â§±Ë¥•: Ê≤°ÊúâÂèØÁî®ÁöÑÈü≥È¢ëÊï∞ÊçÆ');
                showToast('Ê≤°ÊúâÂèØÁî®ÁöÑÈü≥È¢ëÊï∞ÊçÆÔºåËØ∑ÂÖàÁîüÊàêTTS');
                return;
            }
            
                            addLog(`ÂºÄÂßãÊãºÊé•Èü≥È¢ë: È°πÁõÆ${currentSubtitleProject.id}, ÂèØÁî®Èü≥È¢ëÊÆµËêΩ=${segmentsWithAudio.length}`);
            
            // Á¶ÅÁî®ÊåâÈíÆ
            const mergeBtn = document.getElementById('mergeBtn');
            const originalText = mergeBtn.innerHTML;
            mergeBtn.disabled = true;
            mergeBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Ê≠£Âú®ÂêàÂπ∂...';
            
            try {
                addLog('Ë∞ÉÁî®ÊãºÊé•Èü≥È¢ëAPI...');
                showToast('ÂºÄÂßãÊãºÊé•Èü≥È¢ë...');
                
                const formData = new FormData();
                const clientId = generateClientId();
                currentOperationClientId = clientId;
                formData.append('clientId', clientId);
                
                const response = await fetch(`/api/subtitle/${currentSubtitleProject.id}/merge-audio`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(`Èü≥È¢ëÊãºÊé•ÊàêÂäü: ËæìÂá∫Êñá‰ª∂=${result.output_file}, ÊÆµËêΩÊï∞=${result.segments_count}`);
                    showToast(`Èü≥È¢ëÊãºÊé•ÂÆåÊàêÔºÅËæìÂá∫Êñá‰ª∂: ${result.output_file}`);
                    
                    // ÊòæÁ§∫ÂêàÂπ∂ÁªìÊûúÂú®Âõ∫ÂÆö‰ΩçÁΩÆ
                    showMergeResult(result);
                    
                } else {
                    addLog(`Èü≥È¢ëÊãºÊé•Â§±Ë¥•: ${result.message}`);
                    showToast('Èü≥È¢ëÊãºÊé•Â§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('Èü≥È¢ëÊãºÊé•Â§±Ë¥•:', error);
                addLog(`Èü≥È¢ëÊãºÊé•Â§±Ë¥•: ${error.message}`);
                showToast('Èü≥È¢ëÊãºÊé•Â§±Ë¥•: ' + error.message);
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÔºåÊ∏ÖÈô§ÂÆ¢Êà∑Á´ØID
                mergeBtn.disabled = false;
                mergeBtn.innerHTML = originalText;
                currentOperationClientId = null;
            }
        }

        // ÊòæÁ§∫ÂêàÂπ∂ÁªìÊûú
        function showMergeResult(result) {
            const mergeResultCard = document.getElementById('mergeResultCard');
            const mergeDownloadBtn = document.getElementById('mergeDownloadBtn');
            const audioStatus = document.getElementById('audioStatus');
            const playBtn = document.getElementById('mergePlayBtn');
            const pauseBtn = document.getElementById('mergePauseBtn');
            
            // Ê£ÄÊü•ÂøÖË¶ÅÁöÑDOMÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            if (!mergeResultCard) {
                console.error('mergeResultCard not found');
                return;
            }
            
            // ËÆæÁΩÆ‰∏ãËΩΩÈìæÊé•ÔºàÂ¶ÇÊûúÂÖÉÁ¥†Â≠òÂú®Ôºâ
            if (mergeDownloadBtn) {
                mergeDownloadBtn.href = result.download_url;
                mergeDownloadBtn.download = result.output_file;
            }
            
            // ÂêØÁî®Êí≠ÊîæÂô®ÔºàÂ¶ÇÊûúÂÖÉÁ¥†Â≠òÂú®Ôºâ
            if (playBtn) {
                playBtn.disabled = false;
            }
            if (pauseBtn) {
                pauseBtn.disabled = false;
            }
            
            // ÂêØÁî®‰∏ãËΩΩÊåâÈíÆÔºàÂ¶ÇÊûúÂÖÉÁ¥†Â≠òÂú®Ôºâ
            const downloadBtn = document.getElementById('downloadAudioBtn');
            if (downloadBtn) {
                downloadBtn.disabled = false;
            }
            
            // Êõ¥Êñ∞Áä∂ÊÄÅÊèêÁ§∫ÔºàÂ¶ÇÊûúÂÖÉÁ¥†Â≠òÂú®Ôºâ
            if (audioStatus) {
                audioStatus.innerHTML = '';
            }
            
            // ÂàùÂßãÂåñÈü≥È¢ëÊí≠ÊîæÂô®
            initAudioPlayer(result.download_url);
        }

        // ÂàùÂßãÂåñÈü≥È¢ëÊí≠ÊîæÂô®
        let currentAudio = null;
        let audioUpdateTimer = null;
        let audioContext = null;
        let audioAnalyser = null;
        let waveformData = null;

        function initAudioPlayer(audioUrl) {
            // Ê∏ÖÁêÜ‰πãÂâçÁöÑÈü≥È¢ë
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            if (audioUpdateTimer) {
                clearInterval(audioUpdateTimer);
            }
            
            // ÂàõÂª∫Êñ∞ÁöÑÈü≥È¢ëÂØπË±°
            currentAudio = new Audio(audioUrl);
            
            // Ëé∑ÂèñÊí≠ÊîæÂô®ÂÖÉÁ¥†
            const playBtn = document.getElementById('mergePlayBtn');
            const pauseBtn = document.getElementById('mergePauseBtn');
            const progressBar = document.getElementById('audioProgress');
            const currentTimeSpan = document.getElementById('currentTime');
            const totalTimeSpan = document.getElementById('totalTime');
            const volumeSlider = document.getElementById('audioVolume');
            const speedSelect = document.getElementById('audioSpeed');
            const waveformCanvas = document.getElementById('audioWaveform');
            
            // Ê£ÄÊü•ÂøÖË¶ÅÁöÑDOMÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            if (!playBtn || !pauseBtn || !progressBar || !currentTimeSpan || !totalTimeSpan || !waveformCanvas) {
                console.error('Some audio player elements not found');
                return;
            }
            
            // ÁîüÊàêÊ≥¢ÂΩ¢
            generateWaveform(audioUrl, waveformCanvas);
            
            // Ê≥¢ÂΩ¢ÁÇπÂáª‰∫ã‰ª∂
            waveformCanvas.onclick = (event) => {
                if (!currentAudio) return;
                
                const rect = waveformCanvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const progress = x / rect.width;
                const seekTime = progress * currentAudio.duration;
                
                currentAudio.currentTime = seekTime;
                updateWaveformPosition(progress);
                
                // Êõ¥Êñ∞ËøõÂ∫¶Êù°
                progressBar.value = progress * 100;
                currentTimeSpan.textContent = formatTime(seekTime);
            };
            
            // Êí≠ÊîæÊåâÈíÆ‰∫ã‰ª∂
            playBtn.onclick = () => {
                currentAudio.play().then(() => {
                    playBtn.style.display = 'none';
                    pauseBtn.style.display = 'inline-block';
                    startProgressUpdate();
                    startWaveformUpdate();
                }).catch(error => {
                    console.error('Êí≠ÊîæÂ§±Ë¥•:', error);
                    showToast('Êí≠ÊîæÂ§±Ë¥•: ' + error.message);
                });
            };
            
            // ÊöÇÂÅúÊåâÈíÆ‰∫ã‰ª∂
            pauseBtn.onclick = () => {
                currentAudio.pause();
                playBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
                stopProgressUpdate();
                stopWaveformUpdate();
            };
            
            // ËøõÂ∫¶Êù°‰∫ã‰ª∂
            progressBar.oninput = () => {
                if (!currentAudio) return;
                
                const seekTime = (progressBar.value / 100) * currentAudio.duration;
                currentAudio.currentTime = seekTime;
                currentTimeSpan.textContent = formatTime(seekTime);
                updateWaveformPosition(progressBar.value / 100);
            };
            
            // Èü≥È¢ëÂä†ËΩΩÂÆåÊàê‰∫ã‰ª∂
            currentAudio.onloadedmetadata = () => {
                totalTimeSpan.textContent = formatTime(currentAudio.duration);
                progressBar.max = 100;
            };
            
            // Èü≥È¢ëÊí≠Êîæ‰∫ã‰ª∂
            currentAudio.onplay = () => {
                startProgressUpdate();
            };
            
            // Èü≥È¢ëÊöÇÂÅú‰∫ã‰ª∂
            currentAudio.onpause = () => {
                stopProgressUpdate();
            };
            
            // Èü≥È¢ëÁªìÊùü‰∫ã‰ª∂
            currentAudio.onended = () => {
                playBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
                stopProgressUpdate();
                stopWaveformUpdate();
                progressBar.value = 0;
                currentTimeSpan.textContent = '00:00';
                updateWaveformPosition(0);
            };
        }
        
        // ÂºÄÂßãËøõÂ∫¶Êõ¥Êñ∞
        function startProgressUpdate() {
            audioUpdateTimer = setInterval(() => {
                if (currentAudio && !currentAudio.paused) {
                    const progressBar = document.getElementById('audioProgress');
                    const currentTimeSpan = document.getElementById('currentTime');
                    
                    if (progressBar && currentTimeSpan) {
                        const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
                        progressBar.value = progress;
                        currentTimeSpan.textContent = formatTime(currentAudio.currentTime);
                        
                        // Êõ¥Êñ∞Ê≥¢ÂΩ¢Êí≠Êîæ‰ΩçÁΩÆ
                        updateWaveformPosition(currentAudio.currentTime / currentAudio.duration);
                    }
                }
            }, 100);
        }
        
        // ÂÅúÊ≠¢ËøõÂ∫¶Êõ¥Êñ∞
        function stopProgressUpdate() {
            if (audioUpdateTimer) {
                clearInterval(audioUpdateTimer);
                audioUpdateTimer = null;
            }
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Êí≠ÊîæÂêàÂπ∂Èü≥È¢ëÔºàÁÆÄÂåñÁâàÊú¨ÔºåÁî®‰∫éÂÖºÂÆπÔºâ
        function playMergedAudio(audioUrl) {
            try {
                const audio = new Audio(audioUrl);
                audio.play().catch(error => {
                    console.error('Êí≠ÊîæÂ§±Ë¥•:', error);
                    showToast('Êí≠ÊîæÂ§±Ë¥•: ' + error.message);
                });
            } catch (error) {
                console.error('Êí≠ÊîæÂ§±Ë¥•:', error);
                showToast('Êí≠ÊîæÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÂàÜÈ°µÊåâÈíÆ‰∫ã‰ª∂Â§ÑÁêÜ
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadSubtitleSegments();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            currentPage++;
            loadSubtitleSegments();
        });


        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ∑≤‰øùÂ≠òÁöÑÈ°πÁõÆÔºåÂπ∂ËøîÂõûÈ°πÁõÆÂàóË°®
        async function checkForSavedProjects() {
            try {
                console.log('Ê≠£Âú®Ê£ÄÊü•Â∑≤‰øùÂ≠òÁöÑÈ°πÁõÆ...');
                const response = await fetch('/api/projects');
                console.log('È°πÁõÆAPIÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('È°πÁõÆAPIÂìçÂ∫îÊï∞ÊçÆ:', data);
                    
                    if (data.projects && data.projects.length > 0) {
                        console.log(`ÂèëÁé∞ ${data.projects.length} ‰∏™È°πÁõÆ`);
                        return data.projects;
                    } else {
                        console.log('Ê≤°ÊúâÂèëÁé∞È°πÁõÆ');
                    }
                } else {
                    console.log('È°πÁõÆAPIËØ∑Ê±ÇÂ§±Ë¥•:', response.status);
                }
            } catch (error) {
                console.log('Ê£ÄÊü•Â∑≤‰øùÂ≠òÈ°πÁõÆÂ§±Ë¥•:', error);
            }
            return null;
        }

        // Âä†ËΩΩÊåáÂÆöÈ°πÁõÆÁöÑÊÆµËêΩ
        async function loadProjectSegments(projectId) {
            try {
                // ËÆæÁΩÆÂΩìÂâçÈ°πÁõÆ‰ø°ÊÅØ
                currentSubtitleProject = { id: projectId };
                currentPage = 1;
                
                // ‰ΩøÁî®Áé∞ÊúâÁöÑÂä†ËΩΩÂáΩÊï∞
                await loadSubtitleSegments();
                return true;
            } catch (error) {
                console.log('Âä†ËΩΩÈ°πÁõÆÊÆµËêΩÂ§±Ë¥•:', error);
                return false;
            }
        }

        // Ëá™Âä®Âä†ËΩΩÁ§∫‰æãSRTÊñá‰ª∂
        async function loadSampleSrt() {
            try {
                // Ëé∑ÂèñÁ§∫‰æãSRTÊñá‰ª∂
                const response = await fetch('/samples/double_life_English.srt');
                if (!response.ok) {
                    console.log('Á§∫‰æãÊñá‰ª∂‰∏çÂ≠òÂú®ÊàñÊó†Ê≥ïËÆøÈóÆ');
                    return;
                }
                
                const fileContent = await response.text();
                
                // ÂàõÂª∫Êñá‰ª∂ÂØπË±°
                const blob = new Blob([fileContent], { type: 'text/plain' });
                const file = new File([blob], 'double_life_English.srt', { type: 'text/plain' });
                
                // Ë∞ÉÁî®Áé∞ÊúâÁöÑ‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
                await handleQuickSrtUpload(file);
                
                console.log('Á§∫‰æãSRTÊñá‰ª∂Â∑≤Ëá™Âä®Âä†ËΩΩ');
                showToast('‚ú® Â∑≤Ëá™Âä®Âä†ËΩΩÁ§∫‰æãÊñá‰ª∂ÔºöÂèåÈáçÁîüÊ¥ªËã±ÊñáÂ≠óÂπï');
            } catch (error) {
                console.log('Ëá™Âä®Âä†ËΩΩÁ§∫‰æãÊñá‰ª∂Â§±Ë¥•:', error);
                
                // Â¶ÇÊûúËá™Âä®Âä†ËΩΩÂ§±Ë¥•ÔºåÊÅ¢Â§çÈªòËÆ§ÁïåÈù¢
                const container = document.getElementById('subtitleEditor');
                container.innerHTML = `
                    <div class="text-center py-5" style="color: var(--pink-400);">
                        <i class="bi bi-file-earmark-text fs-1"></i>
                        <p class="mt-2">‰∏ä‰º†SRTÊñá‰ª∂ÂºÄÂßãÁºñËæë</p>
                    </div>
                `;
            }
        }

        // Ê∑ªÂä†Êó•ÂøóÂà∞Êó•ÂøóÂÆπÂô®
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            if (!logContainer) return;
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry mb-1 p-1';
            logEntry.textContent = message;  // Áõ¥Êé•‰ΩøÁî®textContentÔºå‰∏çÂÅö‰ªª‰ΩïHTMLÂ§ÑÁêÜ
            
            // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊù°Êó•ÂøóÔºåÊ∏ÖÈô§ÂàùÂßãÊèêÁ§∫
            if (logContainer.querySelector('.text-center')) {
                logContainer.innerHTML = '';
            }
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Ê∏ÖÁ©∫Êó•Âøó
        function clearLogs() {
            const logContainer = document.getElementById('logContainer');
            if (logContainer) {
                logContainer.innerHTML = '';
            }
        }

        // ÈÖçÁΩÆÁÆ°ÁêÜÂäüËÉΩ
        const CREDENTIALS_KEY = 'minimax_tts_credentials';
        const CONFIG_KEY = 'minimax_tts_config';
        
        
        function autoSaveCredentials() {
            const groupId = document.getElementById('groupId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (groupId && apiKey) {
                const credentials = {
                    groupId: groupId,
                    apiKey: apiKey,
                    savedAt: new Date().toISOString()
                };
                
                try {
                    localStorage.setItem(CREDENTIALS_KEY, JSON.stringify(credentials));
                } catch (error) {
                    console.error('‰øùÂ≠òÂá≠ÊçÆÂ§±Ë¥•:', error);
                }
            }
        }

        // ‰øùÂ≠òÊâÄÊúâÈÖçÁΩÆÂèÇÊï∞
        function saveAllConfig() {
            const config = {
                // ËØ≠Èü≥Ê®°Âûã
                voiceModel: document.getElementById('voiceModel').value,
                // ËØ≠Ë®ÄÈÄâÊã©
                language: document.getElementById('language').value,
                // ËØ¥ËØù‰∫∫ËØ≠Èü≥ÈÖçÁΩÆ
                speaker00Voice: document.getElementById('speaker00Voice').value,
                speaker01Voice: document.getElementById('speaker01Voice').value,
                speaker02Voice: document.getElementById('speaker02Voice').value,
                speaker03Voice: document.getElementById('speaker03Voice').value,
                speaker04Voice: document.getElementById('speaker04Voice').value,
                speaker05Voice: document.getElementById('speaker05Voice').value,
                // ‰øùÂ≠òÊó∂Èó¥Êà≥
                savedAt: new Date().toISOString()
            };
            
            try {
                localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
                console.log('ÈÖçÁΩÆÂ∑≤Ëá™Âä®‰øùÂ≠ò, ËØ≠Ë®Ä:', config.language);
            } catch (error) {
                console.error('‰øùÂ≠òÈÖçÁΩÆÂ§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩÊâÄÊúâÈÖçÁΩÆÂèÇÊï∞
        function loadAllConfig() {
            try {
                const saved = localStorage.getItem(CONFIG_KEY);
                if (saved) {
                    const config = JSON.parse(saved);
                    
                    // ÊÅ¢Â§çËØ≠Èü≥Ê®°Âûã
                    if (config.voiceModel) {
                        document.getElementById('voiceModel').value = config.voiceModel;
                    }
                    
                    // ÊÅ¢Â§çËØ≠Ë®ÄÈÄâÊã©
                    if (config.language) {
                        document.getElementById('language').value = config.language;
                        console.log('Â∑≤ÊÅ¢Â§çËØ≠Ë®ÄËÆæÁΩÆ‰∏∫:', config.language);
                    }
                    
                    // ÊÅ¢Â§çËØ¥ËØù‰∫∫ËØ≠Èü≥ÈÖçÁΩÆ
                    if (config.speaker00Voice) {
                        document.getElementById('speaker00Voice').value = config.speaker00Voice;
                    }
                    if (config.speaker01Voice) {
                        document.getElementById('speaker01Voice').value = config.speaker01Voice;
                    }
                    if (config.speaker02Voice) {
                        document.getElementById('speaker02Voice').value = config.speaker02Voice;
                    }
                    if (config.speaker03Voice) {
                        document.getElementById('speaker03Voice').value = config.speaker03Voice;
                    }
                    if (config.speaker04Voice) {
                        document.getElementById('speaker04Voice').value = config.speaker04Voice;
                    }
                    if (config.speaker05Voice) {
                        document.getElementById('speaker05Voice').value = config.speaker05Voice;
                    }
                    
                    console.log('ÈÖçÁΩÆÂ∑≤Ëá™Âä®Âä†ËΩΩ');
                    return true;
                } else {
                    // Ê≤°Êúâ‰øùÂ≠òÁöÑÈÖçÁΩÆÊó∂ÔºåËÆæÁΩÆÈªòËÆ§ËØ≠Ë®Ä‰∏∫‰∏≠Êñá
                    document.getElementById('language').value = 'Chinese';
                    console.log('ËÆæÁΩÆÈªòËÆ§ËØ≠Ë®Ä‰∏∫‰∏≠Êñá');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•:', error);
                // Âá∫ÈîôÊó∂‰πüËÆæÁΩÆÈªòËÆ§ËØ≠Ë®Ä
                document.getElementById('language').value = 'Chinese';
            }
            return false;
        }

        // ÊµãËØïÂáΩÊï∞ - ÊâãÂä®Ê£ÄÊü•ÈÖçÁΩÆ
        function testConfig() {
            console.log('=== ÈÖçÁΩÆÊµãËØï ===');
            const saved = localStorage.getItem(CONFIG_KEY);
            console.log('localStorage‰∏≠ÁöÑÈÖçÁΩÆ:', saved);
            if (saved) {
                const config = JSON.parse(saved);
                console.log('Ëß£ÊûêÂêéÁöÑÈÖçÁΩÆ:', config);
                console.log('‰øùÂ≠òÁöÑËØ≠Ë®Ä:', config.language);
            }
            console.log('ÂΩìÂâçÈ°µÈù¢ËØ≠Ë®ÄÈÄâÊã©Âô®ÁöÑÂÄº:', document.getElementById('language').value);
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéËá™Âä®Âä†ËΩΩÁ§∫‰æãÊñá‰ª∂
        document.addEventListener('DOMContentLoaded', async () => {
            // Âä†ËΩΩHTMLÁªÑ‰ª∂ - Phase 2ÁªÑ‰ª∂Âåñ
            try {
                await componentLoader.loadBatch([
                    { path: 'sections/audio-player.html', target: '#audioPlayerSection' },
                    { path: 'sections/log-display.html', target: '#logDisplaySection' },
                    { path: 'widgets/project-panel.html', target: '#projectPanelSection' },
                    { path: 'widgets/batch-panel.html', target: '#batchPanelSection' },
                    { path: 'modals/add-speaker-modal.html', target: '#modalsSection' }
                ]);
                console.log('‚úÖ ÁªÑ‰ª∂Âä†ËΩΩÂÆåÊàê');
            } catch (error) {
                console.error('‚ùå ÁªÑ‰ª∂Âä†ËΩΩÂ§±Ë¥•:', error);
            }
            
            // ËßíËâ≤ÈÖçÁΩÆÁé∞Âú®Âú®HTML‰∏≠ÈùôÊÄÅÂÆö‰πâÔºåÊó†ÈúÄÂä®ÊÄÅÂä†ËΩΩ
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ∑≤‰øùÂ≠òÁöÑÈ°πÁõÆÔºåÂ¶ÇÊûúÊúâÂàôËá™Âä®Âä†ËΩΩÊúÄËøëÁöÑÈ°πÁõÆ
            const savedProjects = await checkForSavedProjects();
            if (!savedProjects) {
                // Âè™ÊúâÂú®Ê≤°Êúâ‰øùÂ≠òÈ°πÁõÆÊó∂ÊâçÂä†ËΩΩÁ§∫‰æãÊñá‰ª∂
                addLog('Êú™ÂèëÁé∞‰øùÂ≠òÁöÑÈ°πÁõÆÔºåÂä†ËΩΩÁ§∫‰æãÊñá‰ª∂');
                loadSampleSrt();
            } else {
                // Â¶ÇÊûúÊúâ‰øùÂ≠òÁöÑÈ°πÁõÆÔºåËá™Âä®Âä†ËΩΩÊúÄËøëÁöÑÈ°πÁõÆ
                addLog(`ÂèëÁé∞ ${savedProjects.length} ‰∏™‰øùÂ≠òÁöÑÈ°πÁõÆÔºåÊ≠£Âú®Âä†ËΩΩÊúÄËøëÁöÑÈ°πÁõÆ`);
                
                // ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫èÔºåËé∑ÂèñÊúÄËøëÁöÑÈ°πÁõÆ
                const latestProject = savedProjects.sort((a, b) => 
                    new Date(b.updated_at) - new Date(a.updated_at)
                )[0];
                
                addLog(`Ê≠£Âú®Âä†ËΩΩÈ°πÁõÆ: ${latestProject.filename}`);
                
                // Âä†ËΩΩÊúÄËøëÈ°πÁõÆÁöÑÊÆµËêΩ
                const loadSuccess = await loadProjectSegments(latestProject.id);
                if (loadSuccess) {
                    addLog(`‚úÖ È°πÁõÆÂä†ËΩΩÊàêÂäü: ${latestProject.filename}`);
                    
                    // ËÆæÁΩÆÂÖ®Â±ÄÂΩìÂâçÈ°πÁõÆIDÔºàÂ¶ÇÊûúÈ°µÈù¢‰∏≠ÊúâËøô‰∏™ÂèòÈáèÁöÑËØùÔºâ
                    if (typeof window !== 'undefined') {
                        window.currentProjectId = latestProject.id;
                    }
                } else {
                    addLog('‚ùå È°πÁõÆÂä†ËΩΩÂ§±Ë¥•ÔºåÂàáÊç¢Âà∞Á§∫‰æãÊñá‰ª∂');
                    loadSampleSrt();
                }
            }
            
            // ÈöêËóèÁøªËØëÂäüËÉΩÂå∫Âüü
            const translationSection = document.getElementById('translationSection');
            if (translationSection) {
                translationSection.style.display = 'none';
            }
            
            // Ëá™Âä®Âä†ËΩΩ‰øùÂ≠òÁöÑÂá≠ÊçÆ
            try {
                const saved = localStorage.getItem(CREDENTIALS_KEY);
                if (saved) {
                    const credentials = JSON.parse(saved);
                    document.getElementById('groupId').value = credentials.groupId || '';
                    document.getElementById('apiKey').value = credentials.apiKey || '';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂá≠ÊçÆÂ§±Ë¥•:', error);
            }
            
            // Ëá™Âä®Âä†ËΩΩ‰øùÂ≠òÁöÑÈÖçÁΩÆÂèÇÊï∞ - Âª∂ËøüÊâßË°åÁ°Æ‰øùDOMÂÆåÂÖ®Âä†ËΩΩ
            setTimeout(() => {
                const configLoaded = loadAllConfig();
                addLog('ÈÖçÁΩÆÂä†ËΩΩÂÆåÊàêÔºåÂΩìÂâçËØ≠Ë®Ä: ' + document.getElementById('language').value);
                if (configLoaded) {
                    addLog('Â∑≤Ëá™Âä®Âä†ËΩΩ‰øùÂ≠òÁöÑÈÖçÁΩÆÂèÇÊï∞');
                }
            }, 100);
            
            // ÂàùÂßãÂåñÈü≥È¢ëÊí≠ÊîæÂô®Áä∂ÊÄÅ
            initAudioPlayerState();
            
            // ÂàùÂßãÂåñËá™ÂÆö‰πâËßíËâ≤ÂäüËÉΩ
            await loadCustomSpeakers();
            loadCustomSpeakersConfig();
            await updateSpeakerSelectors();
            
            // Ê∑ªÂä†ÂàùÂßãÊó•Âøó
            addLog('Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàê');
            addLog('ËßíËâ≤ËØ≠Èü≥ÈÖçÁΩÆÂ∑≤Âä†ËΩΩ');
            
            
            // Ëá™Âä®‰øùÂ≠òÂäüËÉΩ - Âú®ËæìÂÖ•Ê°ÜÂ§±ÂéªÁÑ¶ÁÇπÊó∂Ëá™Âä®‰øùÂ≠ò
            const groupIdInput = document.getElementById('groupId');
            const apiKeyInput = document.getElementById('apiKey');
            
            if (groupIdInput) {
                groupIdInput.addEventListener('blur', autoSaveCredentials);
            }
            if (apiKeyInput) {
                apiKeyInput.addEventListener('blur', autoSaveCredentials);
            }
            
            // ÈÖçÁΩÆÂèÇÊï∞Ëá™Âä®‰øùÂ≠ò - ÁõëÂê¨ÊâÄÊúâÈÖçÁΩÆËæìÂÖ•Ê°ÜÁöÑÂèòÂåñ
            const configElements = [
                'voiceModel',
                'language', 
                'speaker00Voice',
                'speaker01Voice',
                'speaker02Voice',
                'speaker03Voice',
                'speaker04Voice',
                'speaker05Voice'
            ];
            
            configElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    // ÁõëÂê¨Â§±ÂéªÁÑ¶ÁÇπ‰∫ã‰ª∂ÔºàÂØπinputÁ±ªÂûãÔºâ
                    element.addEventListener('blur', saveAllConfig);
                    // ÁõëÂê¨ÈÄâÊã©ÂèòÂåñ‰∫ã‰ª∂ÔºàÂØπselectÁ±ªÂûãÔºâ
                    element.addEventListener('change', saveAllConfig);
                }
            });
            
            // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÁªëÂÆöÊèíÂÖ•ÊÆµËêΩÊåâÈíÆÔºåÁ°Æ‰øùÂä®ÊÄÅÊ∑ªÂä†ÁöÑÊåâÈíÆ‰πüËÉΩÊ≠£Â∏∏Â∑•‰Ωú
            document.addEventListener('click', function(event) {
                if (event.target.closest('.insert-segment-btn')) {
                    const button = event.target.closest('.insert-segment-btn');
                    const segmentId = button.dataset.segmentId;
                    console.log('ÊèíÂÖ•ÊåâÈíÆÁÇπÂáªÔºåsegment ID:', segmentId);
                    addLog(`üîò ÁÇπÂáªÊèíÂÖ•ÊåâÈíÆÔºåÁõÆÊ†áÊÆµËêΩID: ${segmentId}`);
                    insertAfterSegment(segmentId);
                }
            });

            // ÁªëÂÆöÊ∏ÖÁ©∫Êó•ÂøóÊåâÈíÆ
            const clearLogsBtn = document.getElementById('clearLogsBtn');
            if (clearLogsBtn) {
                clearLogsBtn.addEventListener('click', clearLogs);
            }
            
            // ÁªëÂÆöÈü≥È¢ë‰∏ãËΩΩÊåâÈíÆ
            const downloadAudioBtn = document.getElementById('downloadAudioBtn');
            if (downloadAudioBtn) {
                downloadAudioBtn.addEventListener('click', () => {
                    const mergeDownloadBtn = document.getElementById('mergeDownloadBtn');
                    if (mergeDownloadBtn && mergeDownloadBtn.href !== '#') {
                        mergeDownloadBtn.click();
                    } else {
                        showToast('Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÈü≥È¢ëÊñá‰ª∂');
                    }
                });
            }
            
            // ÁªëÂÆöÂÖ≥Èó≠ÂêàÂπ∂ÁªìÊûúÊåâÈíÆ
            const clearMergeResultBtn = document.getElementById('clearMergeResultBtn');
            if (clearMergeResultBtn) {
                clearMergeResultBtn.addEventListener('click', () => {
                    const mergeResultCard = document.getElementById('mergeResultCard');
                    mergeResultCard.style.display = 'none';
                    
                    // ÂÅúÊ≠¢Èü≥È¢ëÊí≠Êîæ
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio = null;
                    }
                    if (audioUpdateTimer) {
                        clearInterval(audioUpdateTimer);
                        audioUpdateTimer = null;
                    }
                });
            }
        });

        // Â¢ûÂº∫ÁöÑToastÂáΩÊï∞ÔºåÊîØÊåÅ‰∏çÂêåÁ±ªÂûãÁöÑÊ∂àÊÅØ
        function showToast(message, type = 'info') {
            const toastBody = document.getElementById('toastBody');
            const toastElement = document.getElementById('toast');
            
            if (!toastBody || !toastElement) {
                // Â¶ÇÊûúÊ≤°ÊúâtoastÂÖÉÁ¥†Ôºå‰ΩøÁî®alert‰Ωú‰∏∫ÂêéÂ§á
                alert(message);
                return;
            }
            
            toastBody.textContent = message;
            
            // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÊ†∑Âºè
            toastElement.className = 'toast';
            switch(type) {
                case 'success':
                    toastElement.classList.add('bg-success', 'text-white');
                    break;
                case 'warning':
                    toastElement.classList.add('bg-warning', 'text-dark');
                    break;
                case 'error':
                    toastElement.classList.add('bg-danger', 'text-white');
                    break;
                default:
                    toastElement.classList.add('bg-info', 'text-white');
            }
            
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }

        // ÊâπÈáèÁøªËØëÂáΩÊï∞
        async function batchTranslate() {
            if (!currentSubtitleProject) {
                showToast('ËØ∑ÂÖà‰∏ä‰º†SRTÊñá‰ª∂');
                return;
            }
            
            // Ëé∑ÂèñÁøªËØëËØ≠Ë®ÄÔºà‰ΩøÁî®ÈÖçÁΩÆÂèÇÊï∞Âå∫ÁöÑËØ≠Ë®ÄÈÄâÈ°πÔºâ
            const targetLanguage = document.getElementById('language').value;
            if (!targetLanguage) {
                showToast('ËØ∑ÈÄâÊã©ÁõÆÊ†áËØ≠Ë®Ä');
                return;
            }
            
            // Ëé∑ÂèñAPIÈÖçÁΩÆ
            const groupId = document.getElementById('groupId').value;
            const apiKey = document.getElementById('apiKey').value;
            
            if (!groupId || !apiKey) {
                addLog('ÈÖçÁΩÆÈîôËØØ: Áº∫Â∞ëGroup IDÊàñAPI Key');
                showToast('ËØ∑ÂÖàÈÖçÁΩÆGroup IDÂíåAPI Key');
                return;
            }
            
            // Á¶ÅÁî®ÊåâÈíÆ
            const batchTranslateBtn = document.getElementById('batchTranslateBtn');
            const originalText = batchTranslateBtn.innerHTML;
            batchTranslateBtn.disabled = true;
            batchTranslateBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Ê≠£Âú®ÁøªËØë...';
            
            try {
                addLog(`ÂºÄÂßãÊâπÈáèÁøªËØë: ÁõÆÊ†áËØ≠Ë®Ä=${targetLanguage}, ÊÆµËêΩÊï∞=${segments.length}`);
                showToast('ÂºÄÂßãÊâπÈáèÁøªËØë...');
                
                // ÁîüÊàêÂÆ¢Êà∑Á´ØIDÁî®‰∫éÊó•Âøó
                const clientId = generateClientId();
                currentOperationClientId = clientId;
                
                // ÂºÄÂßãÂÆûÊó∂Êó•ÂøóÊõ¥Êñ∞
                startRealTimeLogUpdates(clientId);
                
                const formData = new FormData();
                formData.append('groupId', groupId);
                formData.append('apiKey', apiKey);
                formData.append('apiEndpoint', document.getElementById('apiEndpoint').value);
                formData.append('target_language', targetLanguage);
                formData.append('clientId', clientId);
                
                const response = await fetch(`/api/subtitle/${currentSubtitleProject.id}/batch-translate`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // ÂÅúÊ≠¢ÂÆûÊó∂Êó•ÂøóÊõ¥Êñ∞
                stopRealTimeLogUpdates();
                
                if (result.success) {
                    // ÂÆâÂÖ®Âú∞Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆ
                    const stats = result.statistics || {};
                    const updatedSegments = result.updated_segments || [];
                    
                    // ‰ΩøÁî®Â§öÁßçÊñπÂºèËé∑ÂèñÊÄªÊï∞ÔºåÁ°Æ‰øùÊúâÂÄº
                    const total = stats.total_segments || result.total_segments || updatedSegments.length || segments.length;
                    const successful = stats.successful_segments || result.successful_translations || updatedSegments.length || 0;
                    const failed = stats.failed_segments || result.failed_translations || 0;
                    
                    if (result.interrupted) {
                        addLog(`ÊâπÈáèÁøªËØëË¢´‰∏≠Êñ≠: ${successful}/${total}‰∏™ÊÆµËêΩ, Â∑≤‰øùÂ≠òËøõÂ∫¶`);
                        showToast(`ÊâπÈáèÁøªËØëÂ∑≤‰∏≠Êñ≠ÔºÅÂ∑≤ÂÆåÊàê ${successful}/${total} ‰∏™ÊÆµËêΩ`);
                    } else {
                        addLog(`ÊâπÈáèÁøªËØëÊàêÂäü: ${successful}/${total}‰∏™ÊÆµËêΩ`);
                        if (failed > 0) {
                            addLog(`Â§±Ë¥•ÊÆµËêΩ: ${failed}‰∏™`);
                        }
                        showToast(`ÊâπÈáèÁøªËØëÂÆåÊàêÔºÅÊàêÂäüÂ§ÑÁêÜ ${successful}/${total} ‰∏™ÊÆµËêΩ`);
                    }
                    
                    // ÈáçÊñ∞Âä†ËΩΩÂ≠óÂπïÊÆµËêΩ‰ª•ÊòæÁ§∫ÁøªËØëÁªìÊûú
                    loadSubtitleSegments();
                } else {
                    const errorMessage = result.message || 'Êú™Áü•ÈîôËØØ';
                    addLog(`ÊâπÈáèÁøªËØëÂ§±Ë¥•: ${errorMessage}`);
                    showToast('ÊâπÈáèÁøªËØëÂ§±Ë¥•: ' + errorMessage);
                }
            } catch (error) {
                console.error('ÊâπÈáèÁøªËØëÂ§±Ë¥•:', error);
                // ÂÅúÊ≠¢ÂÆûÊó∂Êó•ÂøóÊõ¥Êñ∞
                stopRealTimeLogUpdates();
                
                let errorMessage = 'Êú™Áü•ÈîôËØØ';
                if (error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'string') {
                    errorMessage = error;
                } else if (error.toString) {
                    errorMessage = error.toString();
                }
                
                addLog(`ÊâπÈáèÁøªËØëÂ§±Ë¥•: ${errorMessage}`);
                showToast('ÊâπÈáèÁøªËØëÂ§±Ë¥•: ' + errorMessage);
            } finally {
                // ÂÅúÊ≠¢ÂÆûÊó∂Êó•ÂøóÊõ¥Êñ∞
                stopRealTimeLogUpdates();
                // ÊÅ¢Â§çÊåâÈíÆÔºåÊ∏ÖÈô§ÂÆ¢Êà∑Á´ØID
                batchTranslateBtn.disabled = false;
                batchTranslateBtn.innerHTML = originalText;
                currentOperationClientId = null;
            }
        }

        // ÂºÄÂßãÂÆûÊó∂Êó•ÂøóÊõ¥Êñ∞
        
        // ÊâπÈáèÈÄâÊã©ÂäüËÉΩ
        let selectedSegmentIds = new Set();

        // Êõ¥Êñ∞ÈÄâ‰∏≠Êï∞ÈáèÊòæÁ§∫
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.segment-checkbox:checked');
            const count = checkboxes.length;
            const selectedCountBadge = document.getElementById('selectedCount');
            const batchOperationSection = document.getElementById('batchOperationSection');
            const batchUpdateBtn = document.getElementById('batchUpdateBtn');
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠ÁöÑÊÆµËêΩIDÈõÜÂêà
            selectedSegmentIds.clear();
            checkboxes.forEach(checkbox => {
                selectedSegmentIds.add(checkbox.getAttribute('data-segment-id'));
            });
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            if (selectedCountBadge) {
                selectedCountBadge.textContent = `Â∑≤ÈÄâÊã©: ${count}`;
            }
            
            // ÊòæÁ§∫ÊàñÈöêËóèÊâπÈáèÊìç‰ΩúÂå∫Âüü
            if (batchOperationSection) {
                batchOperationSection.style.display = count > 0 ? 'flex' : 'none';
            }
            
            // ÂêØÁî®ÊàñÁ¶ÅÁî®ÊâπÈáèÊõ¥Êñ∞ÊåâÈíÆ
            if (batchUpdateBtn) {
                batchUpdateBtn.disabled = count === 0;
            }
        }

        // ÂÖ®ÈÄâÂäüËÉΩ
        function selectAllSegments() {
            const checkboxes = document.querySelectorAll('.segment-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedCount();
        }

        // Ê∏ÖÈô§ÊâÄÊúâÈÄâÊã©
        function clearAllSelections() {
            const checkboxes = document.querySelectorAll('.segment-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount();
        }

        // ÊâπÈáè‰øÆÊîπËØ¥ËØù‰∫∫
        async function batchUpdateSpeaker() {
            if (selectedSegmentIds.size === 0) {
                showToast('ËØ∑ÂÖàÈÄâÊã©Ë¶Å‰øÆÊîπÁöÑÊÆµËêΩ');
                return;
            }
            
            const newSpeaker = document.getElementById('batchSpeakerSelect').value;
            if (!newSpeaker) {
                showToast('ËØ∑ÈÄâÊã©Ë¶ÅËÆæÁΩÆÁöÑËØ¥ËØù‰∫∫');
                return;
            }
            
            if (!currentSubtitleProject) {
                showToast('ËØ∑ÂÖà‰∏ä‰º†SRTÊñá‰ª∂');
                return;
            }
            
            // Á°ÆËÆ§Êìç‰Ωú
            if (!confirm(`Á°ÆÂÆöË¶ÅÂ∞ÜÈÄâ‰∏≠ÁöÑ ${selectedSegmentIds.size} ‰∏™ÊÆµËêΩÁöÑËØ¥ËØù‰∫∫‰øÆÊîπ‰∏∫ ${newSpeaker} ÂêóÔºü`)) {
                return;
            }
            
            const batchUpdateBtn = document.getElementById('batchUpdateBtn');
            const originalText = batchUpdateBtn.innerHTML;
            batchUpdateBtn.disabled = true;
            batchUpdateBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Ê≠£Âú®‰øÆÊîπ...';
            
            try {
                addLog(`ÂºÄÂßãÊâπÈáè‰øÆÊîπËØ¥ËØù‰∫∫: ${selectedSegmentIds.size}‰∏™ÊÆµËêΩ ‚Üí ${newSpeaker}`);
                
                const response = await fetch(`/api/subtitle/${currentSubtitleProject.id}/batch-update-speaker`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        segment_ids: Array.from(selectedSegmentIds),
                        speaker: newSpeaker
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const updatedCount = result.updated_count || selectedSegmentIds.size;
                    addLog(`ÊâπÈáè‰øÆÊîπËØ¥ËØù‰∫∫ÊàêÂäü: ${updatedCount}‰∏™ÊÆµËêΩÂ∑≤Êõ¥Êñ∞`);
                    showToast(`ÊàêÂäü‰øÆÊîπ ${updatedCount} ‰∏™ÊÆµËêΩÁöÑËØ¥ËØù‰∫∫‰∏∫ ${newSpeaker}`);
                    
                    // Ê∏ÖÈô§ÈÄâÊã©Âπ∂ÈáçÊñ∞Âä†ËΩΩÊÆµËêΩ
                    clearAllSelections();
                    await loadSubtitleSegments();
                } else {
                    addLog(`ÊâπÈáè‰øÆÊîπËØ¥ËØù‰∫∫Â§±Ë¥•: ${result.message}`);
                    showToast('ÊâπÈáè‰øÆÊîπÂ§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('ÊâπÈáè‰øÆÊîπËØ¥ËØù‰∫∫Â§±Ë¥•:', error);
                addLog(`ÊâπÈáè‰øÆÊîπËØ¥ËØù‰∫∫Â§±Ë¥•: ${error.message}`);
                showToast('ÊâπÈáè‰øÆÊîπÂ§±Ë¥•: ' + error.message);
            } finally {
                batchUpdateBtn.disabled = false;
                batchUpdateBtn.innerHTML = originalText;
            }
        }

        // ÂàáÊç¢ÊâπÈáèËØ¥ËØù‰∫∫Èù¢ÊùøÊòæÁ§∫
        function toggleBatchSpeakerPanel() {
            const panel = document.getElementById('batchSpeakerPanel');
            const toggle = document.getElementById('batchSpeakerToggle');
            
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                toggle.classList.remove('btn-outline-primary');
                toggle.classList.add('btn-primary');
                toggle.innerHTML = '<i class="bi bi-people-fill me-1"></i>ÂÖ≥Èó≠Èù¢Êùø';
            } else {
                panel.style.display = 'none';
                toggle.classList.remove('btn-primary');
                toggle.classList.add('btn-outline-primary');
                toggle.innerHTML = '<i class="bi bi-people-fill me-1"></i>ÊâπÈáèÊîπËØ¥ËØù‰∫∫';
            }
        }
    </script>
    <script>
        // ÂÅúÊ≠¢ËøõÂ∫¶Êõ¥Êñ∞
        function stopProgressUpdate() {
            if (audioUpdateTimer) {
                clearInterval(audioUpdateTimer);
                audioUpdateTimer = null;
            }
        }
        
        // ÁîüÊàêÈü≥È¢ëÊ≥¢ÂΩ¢
        async function generateWaveform(audioUrl, canvas) {
            try {
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;
                
                // Ê∏ÖÁ©∫ÁîªÂ∏É
                ctx.clearRect(0, 0, width, height);
                
                // ÂàõÂª∫Èü≥È¢ë‰∏ä‰∏ãÊñá
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Ëé∑ÂèñÈü≥È¢ëÊï∞ÊçÆ
                const response = await fetch(audioUrl);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // Ëé∑ÂèñÈü≥È¢ëÊï∞ÊçÆ
                const channelData = audioBuffer.getChannelData(0);
                const dataLength = channelData.length;
                
                // ËÆ°ÁÆóÈááÊ†∑Èó¥Èöî
                const sampleStep = Math.ceil(dataLength / width);
                const samples = [];
                
                // ÈááÊ†∑Êï∞ÊçÆ
                for (let i = 0; i < width; i++) {
                    const start = i * sampleStep;
                    const end = Math.min(start + sampleStep, dataLength);
                    let sum = 0;
                    let count = 0;
                    
                    for (let j = start; j < end; j++) {
                        sum += Math.abs(channelData[j]);
                        count++;
                    }
                    
                    samples.push(sum / count);
                }
                
                // Â≠òÂÇ®Ê≥¢ÂΩ¢Êï∞ÊçÆ
                waveformData = samples;
                
                // ÁªòÂà∂Ê≥¢ÂΩ¢
                drawWaveform(ctx, samples, width, height);
                
            } catch (error) {
                console.error('Ê≥¢ÂΩ¢ÁîüÊàêÂ§±Ë¥•:', error);
                // ÁªòÂà∂ÈîôËØØÊèêÁ§∫
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#6c757d';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Ê≥¢ÂΩ¢Âä†ËΩΩÂ§±Ë¥•', canvas.width / 2, canvas.height / 2);
            }
        }
        
        // ÁªòÂà∂Ê≥¢ÂΩ¢
        function drawWaveform(ctx, samples, width, height) {
            const centerY = height / 2;
            const maxAmplitude = Math.max(...samples);
            
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 1;
            ctx.beginPath();
            
            for (let i = 0; i < samples.length; i++) {
                const x = i;
                const amplitude = (samples[i] / maxAmplitude) * (height / 2);
                const y1 = centerY - amplitude;
                const y2 = centerY + amplitude;
                
                ctx.moveTo(x, y1);
                ctx.lineTo(x, y2);
            }
            
            ctx.stroke();
        }
        
        // Êõ¥Êñ∞Ê≥¢ÂΩ¢Êí≠Êîæ‰ΩçÁΩÆ
        function updateWaveformPosition(progress) {
            if (!waveformData) return;
            
            const canvas = document.getElementById('audioWaveform');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // ÈáçÊñ∞ÁªòÂà∂Ê≥¢ÂΩ¢
            drawWaveform(ctx, waveformData, width, height);
            
            // ÁªòÂà∂Êí≠Êîæ‰ΩçÁΩÆÊåáÁ§∫Âô®
            const playPosition = progress * width;
            ctx.strokeStyle = '#dc3545';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(playPosition, 0);
            ctx.lineTo(playPosition, height);
            ctx.stroke();
        }
        
        // ÂºÄÂßãÊ≥¢ÂΩ¢Êõ¥Êñ∞
        function startWaveformUpdate() {
            // Ê≥¢ÂΩ¢Êõ¥Êñ∞Â∑≤ÁªèÈõÜÊàêÂà∞ËøõÂ∫¶Êõ¥Êñ∞‰∏≠
        }
        
        // ÂÅúÊ≠¢Ê≥¢ÂΩ¢Êõ¥Êñ∞
        function stopWaveformUpdate() {
            // Ê≥¢ÂΩ¢Êõ¥Êñ∞Â∑≤ÁªèÈõÜÊàêÂà∞ËøõÂ∫¶Êõ¥Êñ∞‰∏≠Ôºå‰∏çÈúÄË¶ÅÂçïÁã¨ÂÅúÊ≠¢
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥ÔºàÁî®‰∫éÈü≥È¢ëÊí≠ÊîæÊó∂ÈïøÊòæÁ§∫Ôºâ
        function formatPlaybackTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
    <script>
        
        // ÂàùÂßãÂåñÈü≥È¢ëÊí≠ÊîæÂô®Áä∂ÊÄÅ
        function initAudioPlayerState() {
            const playBtn = document.getElementById('mergePlayBtn');
            const pauseBtn = document.getElementById('mergePauseBtn');
            const audioStatus = document.getElementById('audioStatus');
            const waveformCanvas = document.getElementById('audioWaveform');
            
            // Ê£ÄÊü•ÂøÖË¶ÅÁöÑDOMÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            if (!playBtn || !pauseBtn || !audioStatus || !waveformCanvas) {
                console.error('Some audio player state elements not found');
                return;
            }
            
            // Á°Æ‰øùÊí≠ÊîæÂô®ÈªòËÆ§ÊòæÁ§∫‰ΩÜÁ¶ÅÁî®
            playBtn.disabled = true;
            pauseBtn.disabled = true;
            
            // ÂàùÂßãÂåñÊ≥¢ÂΩ¢ÊòæÁ§∫Á≠âÂæÖÁä∂ÊÄÅ
            const ctx = waveformCanvas.getContext('2d');
            ctx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);
            ctx.fillStyle = '#6c757d';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Á≠âÂæÖÈü≥È¢ëÊï∞ÊçÆ...', waveformCanvas.width / 2, waveformCanvas.height / 2);
            
            // ËÆæÁΩÆÈªòËÆ§Áä∂ÊÄÅÊèêÁ§∫
            audioStatus.innerHTML = ``;
        }
    </script>
    <script>
        // Â≠òÂÇ®ÂΩìÂâçÊìç‰ΩúÁöÑÂÆ¢Êà∑Á´ØID
        let currentOperationClientId = null;
        
        // ‰∏≠Êñ≠ÂΩìÂâç‰ªªÂä°ÂáΩÊï∞
        async function interruptCurrentTask() {
            if (!currentSubtitleProject || !currentOperationClientId) {
                showToast('Ê≤°ÊúâÊ≠£Âú®ËøêË°åÁöÑ‰ªªÂä°');
                return;
            }
            
            try {
                addLog('Áî®Êà∑ËØ∑Ê±Ç‰∏≠Êñ≠‰ªªÂä°...');
                showToast('Ê≠£Âú®‰∏≠Êñ≠‰ªªÂä°...');
                
                const response = await fetch(`/api/interrupt/${currentOperationClientId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('‰∏≠Êñ≠ËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅ');
                    showToast('‰ªªÂä°‰∏≠Êñ≠ËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅ');
                } else {
                    addLog(`‰∏≠Êñ≠Â§±Ë¥•: ${result.message}`);
                    showToast('‰ªªÂä°‰∏≠Êñ≠Â§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('‰∏≠Êñ≠‰ªªÂä°Â§±Ë¥•:', error);
                addLog(`‰∏≠Êñ≠‰ªªÂä°Â§±Ë¥•: ${error.message}`);
                showToast('‰∏≠Êñ≠‰ªªÂä°Â§±Ë¥•: ' + error.message);
            }
        }
        

        // ‰∏ÄÈîÆÁøªËØëÂáΩÊï∞ - Ëá™Âä®ÊåâÈ°∫Â∫èÊâßË°åÁøªËØë„ÄÅTTS„ÄÅÂêàÂπ∂
        async function oneClickTranslate() {
            console.log('‰∏ÄÈîÆÁøªËØëÊåâÈíÆË¢´ÁÇπÂáª');
            if (!currentSubtitleProject) {
                showToast('ËØ∑ÂÖà‰∏ä‰º†SRTÊñá‰ª∂');
                return;
            }
            
            // Ëé∑ÂèñAPIÈÖçÁΩÆ
            const groupId = document.getElementById('groupId').value;
            const apiKey = document.getElementById('apiKey').value;
            
            if (!groupId || !apiKey) {
                addLog('ÈÖçÁΩÆÈîôËØØ: Áº∫Â∞ëGroup IDÊàñAPI Key');
                showToast('ËØ∑ÂÖàÈÖçÁΩÆGroup IDÂíåAPI Key');
                return;
            }
            
            // Ëé∑ÂèñÁøªËØëËØ≠Ë®Ä
            const targetLanguage = document.getElementById('language').value;
            if (!targetLanguage) {
                showToast('ËØ∑ÈÄâÊã©ÁõÆÊ†áËØ≠Ë®Ä');
                return;
            }
            
            // Á¶ÅÁî®‰∏ÄÈîÆÁøªËØëÊåâÈíÆ
            const oneClickBtn = document.getElementById('oneClickTranslateBtn');
            const originalText = oneClickBtn.innerHTML;
            oneClickBtn.disabled = true;
            oneClickBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Ê≠£Âú®Â§ÑÁêÜ...';
            
            // ÁîüÊàêÂÆ¢Êà∑Á´ØIDÁî®‰∫é‰∏ÄÈîÆÁøªËØë
            currentOperationClientId = generateClientId();
            
            try {
                addLog('=== ÂºÄÂßã‰∏ÄÈîÆÁøªËØëÊµÅÁ®ã ===');
                showToast('ÂºÄÂßã‰∏ÄÈîÆÁøªËØëÊµÅÁ®ã...');
                
                // Á¨¨‰∏ÄÊ≠•ÔºöÊâπÈáèÁøªËØë
                addLog('Ê≠•È™§1: ÂºÄÂßãÊâπÈáèÁøªËØë...');
                const translateResult = await executeBatchTranslate(targetLanguage, groupId, apiKey);
                if (!translateResult.success) {
                    throw new Error(`ÁøªËØëÂ§±Ë¥•: ${translateResult.message}`);
                }
                addLog('Ê≠•È™§1: ÊâπÈáèÁøªËØëÂÆåÊàê');
                
                // Á¨¨‰∫åÊ≠•ÔºöÊâπÈáèTTS
                addLog('Ê≠•È™§2: ÂºÄÂßãÊâπÈáèTTS...');
                const ttsResult = await executeBatchTTS(groupId, apiKey);
                if (!ttsResult.success) {
                    throw new Error(`TTSÂ§±Ë¥•: ${ttsResult.message}`);
                }
                addLog('Ê≠•È™§2: ÊâπÈáèTTSÂÆåÊàê');
                
                // Á¨¨‰∏âÊ≠•ÔºöÊãºÊé•Èü≥È¢ë
                addLog('Ê≠•È™§3: ÂºÄÂßãÊãºÊé•Èü≥È¢ë...');
                const mergeResult = await executeMergeAudio();
                if (!mergeResult.success) {
                    throw new Error(`ÊãºÊé•Â§±Ë¥•: ${mergeResult.message}`);
                }
                addLog('Ê≠•È™§3: ÊãºÊé•Èü≥È¢ëÂÆåÊàê');
                
                addLog('=== ‰∏ÄÈîÆÁøªËØëÊµÅÁ®ãÂÆåÊàê ===');
                showToast('‰∏ÄÈîÆÁøªËØëÂÆåÊàêÔºÅÈü≥È¢ëÂ∑≤ÂáÜÂ§áÂ∞±Áª™');
                
            } catch (error) {
                console.error('‰∏ÄÈîÆÁøªËØëÂ§±Ë¥•:', error);
                addLog(`‰∏ÄÈîÆÁøªËØëÂ§±Ë¥•: ${error.message}`);
                showToast('‰∏ÄÈîÆÁøªËØëÂ§±Ë¥•: ' + error.message);
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅÔºåÊ∏ÖÈô§ÂÆ¢Êà∑Á´ØID
                oneClickBtn.disabled = false;
                oneClickBtn.innerHTML = originalText;
                currentOperationClientId = null;
            }
        }

        // ÊâßË°åÊâπÈáèÁøªËØëÁöÑËæÖÂä©ÂáΩÊï∞
        async function executeBatchTranslate(targetLanguage, groupId, apiKey) {
            startRealTimeLogUpdates(currentOperationClientId);
            
            try {
                const formData = new FormData();
                formData.append('groupId', groupId);
                formData.append('apiKey', apiKey);
                formData.append('apiEndpoint', document.getElementById('apiEndpoint').value);
                formData.append('target_language', targetLanguage);
                formData.append('clientId', currentOperationClientId);
                
                const response = await fetch(`/api/subtitle/${currentSubtitleProject.id}/batch-translate`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                stopRealTimeLogUpdates();
                
                if (result.success) {
                    loadSubtitleSegments(); // ÈáçÊñ∞Âä†ËΩΩ‰ª•ÊòæÁ§∫ÁøªËØëÁªìÊûú
                }
                
                return result;
            } catch (error) {
                stopRealTimeLogUpdates();
                return { success: false, message: error.message };
            }
        }

        // ÊâßË°åÊâπÈáèTTSÁöÑËæÖÂä©ÂáΩÊï∞
        async function executeBatchTTS(groupId, apiKey) {
            startRealTimeLogUpdates(currentOperationClientId);
            
            try {
                const formData = new FormData();
                formData.append('groupId', groupId);
                formData.append('apiKey', apiKey);
                formData.append('apiEndpoint', document.getElementById('apiEndpoint').value);
                formData.append('model', document.getElementById('voiceModel').value);
                formData.append('language', document.getElementById('language').value);
                formData.append('voiceMapping', JSON.stringify(getVoiceMapping()));
                formData.append('clientId', currentOperationClientId);
                
                const response = await fetch(`/api/subtitle/${currentSubtitleProject.id}/batch-generate-tts`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                stopRealTimeLogUpdates();
                
                if (result.success) {
                    loadSubtitleSegments(); // ÈáçÊñ∞Âä†ËΩΩ‰ª•ÊòæÁ§∫TTSÁªìÊûú
                }
                
                return result;
            } catch (error) {
                stopRealTimeLogUpdates();
                return { success: false, message: error.message };
            }
        }

        // ÊâßË°åÊãºÊé•Èü≥È¢ëÁöÑËæÖÂä©ÂáΩÊï∞
        async function executeMergeAudio() {
            startRealTimeLogUpdates(currentOperationClientId);
            
            try {
                const formData = new FormData();
                formData.append('clientId', currentOperationClientId);
                
                const response = await fetch(`/api/subtitle/${currentSubtitleProject.id}/merge-audio`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                stopRealTimeLogUpdates();
                
                if (result.success) {
                    showMergeResult(result);
                }
                
                return result;
            } catch (error) {
                stopRealTimeLogUpdates();
                return { success: false, message: error.message };
            }
        }

        // ÊñáÊú¨ÈïøÂ∫¶Ë∞ÉÊï¥ÂáΩÊï∞
        async function adjustSegmentText(segmentId, adjustmentType) {
            if (!currentSubtitleProject) {
                addLog('Êìç‰ΩúÈîôËØØ: ËØ∑ÂÖà‰∏ä‰º†SRTÊñá‰ª∂', 'error');
                return;
            }

            // Ëé∑ÂèñÂΩìÂâçÈÖçÁΩÆ
            const groupId = document.getElementById('groupId')?.value;
            const apiKey = document.getElementById('apiKey')?.value;
            const targetLanguage = document.getElementById('language')?.value;
            const apiEndpoint = document.getElementById('apiEndpoint')?.value || 'domestic';

            if (!groupId || !apiKey) {
                addLog('ÈÖçÁΩÆÈîôËØØ: ËØ∑ÂÖàÂ°´ÂÜôAPIÈÖçÁΩÆ‰ø°ÊÅØ', 'error');
                return;
            }

            if (!targetLanguage) {
                addLog('ÈÖçÁΩÆÈîôËØØ: ËØ∑ÂÖàÈÄâÊã©ÁõÆÊ†áËØ≠Ë®Ä', 'error');
                return;
            }

            // Êü•ÊâæÊåâÈíÆÂπ∂ËÆæÁΩÆÂä†ËΩΩÁä∂ÊÄÅ
            const buttons = document.querySelectorAll(`[data-segment-id="${segmentId}"].text-adjust-btn`);
            const targetButton = Array.from(buttons).find(btn => btn.dataset.adjustmentType === adjustmentType);
            
            if (!targetButton) {
                return;
            }

            const originalText = targetButton.innerHTML;
            const actionText = adjustmentType === 'shorten' ? 'Áº©Áü≠' : 'Âä†Èïø';
            
            // Á¶ÅÁî®ÊâÄÊúâË∞ÉÊï¥ÊåâÈíÆ
            buttons.forEach(btn => btn.disabled = true);
            targetButton.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span>${actionText}‰∏≠...`;

            try {
                // ÂáÜÂ§áË°®ÂçïÊï∞ÊçÆ
                const formData = new FormData();
                formData.append('adjustment_type', adjustmentType);
                formData.append('groupId', groupId);
                formData.append('apiKey', apiKey);
                formData.append('target_language', targetLanguage);
                formData.append('apiEndpoint', apiEndpoint);

                // ÂèëÈÄÅË∞ÉÊï¥ËØ∑Ê±Ç
                const url = `/api/subtitle/${currentSubtitleProject.id}/segment/${segmentId}/adjust-text`;
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // ËÆ∞ÂΩïÊàêÂäü‰ø°ÊÅØÂà∞Êó•ÂøóÔºå‰∏çÊòæÁ§∫ÂºπÁ™ó
                    const changeInfo = result.length_change;
                    const changeText = changeInfo.change_percentage > 0 ? 
                        `Â¢ûÂä†${changeInfo.change_percentage}%` : 
                        `ÂáèÂ∞ë${Math.abs(changeInfo.change_percentage)}%`;
                    
                    addLog(`ÊñáÊú¨${actionText}ÊàêÂäü: ${changeInfo.original_length} ‚Üí ${changeInfo.new_length} Â≠ó (${changeText})`, 'success');

                    // Êõ¥Êñ∞ÊÆµËêΩÊòæÁ§∫‰∏≠ÁöÑËØëÊñá
                    const translationElement = document.querySelector(`[data-segment-id="${segmentId}"] .translation-text`);
                    if (translationElement) {
                        translationElement.textContent = `ËØëÊñá: ${result.adjusted_text}`;
                        
                        // Ê∑ªÂä†Êõ¥Êñ∞Âä®ÁîªÊïàÊûú
                        translationElement.style.backgroundColor = '#d4edda';
                        translationElement.style.border = '1px solid #c3e6cb';
                        translationElement.style.borderRadius = '0.25rem';
                        translationElement.style.padding = '0.25rem';
                        setTimeout(() => {
                            translationElement.style.backgroundColor = '';
                            translationElement.style.border = '';
                            translationElement.style.borderRadius = '';
                            translationElement.style.padding = '';
                        }, 2000);
                    }

                    // Êõ¥Êñ∞segmentsÊï∞ÁªÑ‰∏≠ÁöÑÊï∞ÊçÆ
                    const segmentIndex = segments.findIndex(s => s.id === segmentId);
                    if (segmentIndex !== -1) {
                        segments[segmentIndex].translated_text = result.adjusted_text;
                    }
                    
                    // ÈáçÊñ∞Âä†ËΩΩÊÆµËêΩÊï∞ÊçÆ‰ª•Á°Æ‰øùÈ°πÁõÆ‰∏≠ÁöÑÊï∞ÊçÆ‰πüÊòØÊúÄÊñ∞ÁöÑ
                    await loadSubtitleSegments();
                    
                    // ËÆ∞ÂΩïÂà∞Êó•Âøó
                    addLog(`ÊÆµËêΩ ${segmentId} ÊñáÊú¨${actionText}ÊàêÂäüÔºö${changeInfo.original_length} ‚Üí ${changeInfo.new_length} Â≠ó`, 'success');
                } else {
                    throw new Error(result.message || `ÊñáÊú¨${actionText}Â§±Ë¥•`);
                }

            } catch (error) {
                console.error(`ÊñáÊú¨${actionText}Â§±Ë¥•:`, error);
                addLog(`ÊñáÊú¨${actionText}Â§±Ë¥•: ${error.message}`, 'error');
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                buttons.forEach(btn => btn.disabled = false);
                targetButton.innerHTML = originalText;
            }
        }

        // Ëé∑ÂèñÂΩìÂâçÈ°πÁõÆIDÁöÑËæÖÂä©ÂáΩÊï∞
        function getCurrentProjectId() {
            return currentSubtitleProject ? currentSubtitleProject.id : null;
        }

        // ================== Ëá™ÂÆö‰πâËßíËâ≤ÁÆ°ÁêÜÂäüËÉΩ ==================

        // ÊòæÁ§∫Ê∑ªÂä†ËßíËâ≤Ê®°ÊÄÅÊ°Ü
        function showAddSpeakerModal() {
            // Ê∏ÖÁ©∫Ë°®Âçï
            document.getElementById('speakerVoiceId').value = '';
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            const modal = new bootstrap.Modal(document.getElementById('addSpeakerModal'));
            modal.show();
        }

        // Ê∑ªÂä†Ëá™ÂÆö‰πâËßíËâ≤
        async function addCustomSpeaker() {
            const voiceId = document.getElementById('speakerVoiceId').value.trim();

            if (!voiceId) {
                addLog('ËØ∑Â°´ÂÜôËØ≠Èü≥ID', 'error');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('voice_id', voiceId);

                const response = await fetch('/api/custom-speakers', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    addLog(`‚úÖ ÊàêÂäüÊ∑ªÂä†Ëá™ÂÆö‰πâËßíËâ≤: ${result.speaker.name}`, 'success');
                    
                    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addSpeakerModal'));
                    modal.hide();
                    
                    // Âà∑Êñ∞Ëá™ÂÆö‰πâËßíËâ≤ÂàóË°®
                    await loadCustomSpeakers();
                    
                    // Êõ¥Êñ∞ËØ¥ËØù‰∫∫ÈÄâÊã©Âô®
                    updateSpeakerSelectors();
                } else {
                    addLog(`‚ùå Ê∑ªÂä†ËßíËâ≤Â§±Ë¥•: ${result.detail || result.message}`, 'error');
                }
            } catch (error) {
                console.error('Ê∑ªÂä†Ëá™ÂÆö‰πâËßíËâ≤Â§±Ë¥•:', error);
                addLog(`‚ùå Ê∑ªÂä†ËßíËâ≤Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // Âä†ËΩΩËá™ÂÆö‰πâËßíËâ≤ÂàóË°®
        async function loadCustomSpeakers() {
            try {
                const response = await fetch('/api/custom-speakers');
                const result = await response.json();

                if (result.success) {
                    renderCustomSpeakers(result.speakers);
                }
            } catch (error) {
                console.error('Âä†ËΩΩËá™ÂÆö‰πâËßíËâ≤Â§±Ë¥•:', error);
            }
        }

        // Ê∏≤ÊüìËá™ÂÆö‰πâËßíËâ≤ÂàóË°®
        function renderCustomSpeakers(speakers) {
            const container = document.getElementById('customSpeakersContainer');
            
            if (speakers.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '<div class="border-top pt-3 mt-3"><h6 class="text-muted mb-3">Ëá™ÂÆö‰πâËßíËâ≤</h6>';
            
            speakers.forEach((speaker, index) => {
                const rowClass = index % 2 === 0 ? 'row g-3 mb-3' : 'row g-3 mb-3';
                const colClass = index % 2 === 0 ? 'col-6' : 'col-6';
                
                if (index % 2 === 0) {
                    html += '<div class="row g-3 mb-3">';
                }
                
                html += `
                    <div class="${colClass}">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <label class="form-label small">${speaker.name}</label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="customSpeaker_${speaker.id}" 
                                       value="${speaker.voice_id}"
                                       data-speaker-id="${speaker.id}"
                                       data-speaker-name="${speaker.name}"
                                       onchange="updateCustomSpeakerVoice('${speaker.id}', this.value)">
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" 
                                    onclick="deleteCustomSpeaker('${speaker.id}', '${speaker.name}')"
                                    title="Âà†Èô§ËßíËâ≤">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                if (index % 2 === 1 || index === speakers.length - 1) {
                    html += '</div>';
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Êõ¥Êñ∞Ëá™ÂÆö‰πâËßíËâ≤ËØ≠Èü≥
        async function updateCustomSpeakerVoice(speakerId, voiceId) {
            try {
                const formData = new FormData();
                formData.append('voice_id', voiceId);

                const response = await fetch(`/api/custom-speakers/${speakerId}`, {
                    method: 'PUT',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    addLog(`‚úÖ Â∑≤Êõ¥Êñ∞ËßíËâ≤ËØ≠Èü≥: ${result.speaker.name} -> ${voiceId}`, 'success');
                    saveCustomSpeakersConfig(); // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                } else {
                    addLog(`‚ùå Êõ¥Êñ∞ËßíËâ≤ËØ≠Èü≥Â§±Ë¥•: ${result.detail || result.message}`, 'error');
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Ëá™ÂÆö‰πâËßíËâ≤ËØ≠Èü≥Â§±Ë¥•:', error);
                addLog(`‚ùå Êõ¥Êñ∞ËßíËâ≤ËØ≠Èü≥Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // Âà†Èô§Ëá™ÂÆö‰πâËßíËâ≤
        async function deleteCustomSpeaker(speakerId, speakerName) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ëá™ÂÆö‰πâËßíËâ≤ "${speakerName}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/custom-speakers/${speakerId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    addLog(`‚úÖ Â∑≤Âà†Èô§Ëá™ÂÆö‰πâËßíËâ≤: ${speakerName}`, 'success');
                    
                    // Âà∑Êñ∞Ëá™ÂÆö‰πâËßíËâ≤ÂàóË°®
                    await loadCustomSpeakers();
                    
                    // Êõ¥Êñ∞ËØ¥ËØù‰∫∫ÈÄâÊã©Âô®
                    updateSpeakerSelectors();
                } else {
                    addLog(`‚ùå Âà†Èô§ËßíËâ≤Â§±Ë¥•: ${result.detail || result.message}`, 'error');
                }
            } catch (error) {
                console.error('Âà†Èô§Ëá™ÂÆö‰πâËßíËâ≤Â§±Ë¥•:', error);
                addLog(`‚ùå Âà†Èô§ËßíËâ≤Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // Êõ¥Êñ∞ËØ¥ËØù‰∫∫ÈÄâÊã©Âô®ÔºàÊâπÈáèÊìç‰ΩúÂíåÂÖ∂‰ªñÂú∞Êñπ‰ΩøÁî®Ôºâ
        async function updateSpeakerSelectors() {
            try {
                const response = await fetch('/api/all-speakers');
                const result = await response.json();

                if (result.success) {
                    // Êõ¥Êñ∞ÊâπÈáèËØ¥ËØù‰∫∫ÈÄâÊã©Âô®
                    const batchSelect = document.getElementById('batchSpeakerSelect');
                    if (batchSelect) {
                        const currentValue = batchSelect.value;
                        batchSelect.innerHTML = '<option value="">ÈÄâÊã©ËØ¥ËØù‰∫∫</option>';
                        
                        result.all_speaker_names.forEach(speakerName => {
                            const option = document.createElement('option');
                            option.value = speakerName;
                            option.textContent = speakerName;
                            batchSelect.appendChild(option);
                        });
                        
                        // ÊÅ¢Â§ç‰πãÂâçÁöÑÈÄâÊã©
                        if (currentValue) {
                            batchSelect.value = currentValue;
                        }
                    }
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞ËØ¥ËØù‰∫∫ÈÄâÊã©Âô®Â§±Ë¥•:', error);
            }
        }

        // ‰øùÂ≠òËá™ÂÆö‰πâËßíËâ≤ÈÖçÁΩÆÂà∞Êú¨Âú∞Â≠òÂÇ®
        function saveCustomSpeakersConfig() {
            const customInputs = document.querySelectorAll('[id^="customSpeaker_"]');
            const config = {};
            
            customInputs.forEach(input => {
                const speakerId = input.dataset.speakerId;
                const speakerName = input.dataset.speakerName;
                config[speakerId] = {
                    name: speakerName,
                    voice_id: input.value
                };
            });
            
            try {
                localStorage.setItem('custom_speakers_config', JSON.stringify(config));
            } catch (error) {
                console.error('‰øùÂ≠òËá™ÂÆö‰πâËßíËâ≤ÈÖçÁΩÆÂ§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩËá™ÂÆö‰πâËßíËâ≤ÈÖçÁΩÆ
        function loadCustomSpeakersConfig() {
            try {
                const saved = localStorage.getItem('custom_speakers_config');
                if (saved) {
                    const config = JSON.parse(saved);
                    
                    Object.keys(config).forEach(speakerId => {
                        const input = document.getElementById(`customSpeaker_${speakerId}`);
                        if (input && config[speakerId].voice_id) {
                            input.value = config[speakerId].voice_id;
                        }
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩËá™ÂÆö‰πâËßíËâ≤ÈÖçÁΩÆÂ§±Ë¥•:', error);
            }
        }
    </script>
</body>
</html> 
